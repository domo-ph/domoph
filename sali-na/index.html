<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign up - Domo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --primary-default: #3B268C;
            --primary-darker: #34227C;
            --secondary-default: #1B7A9D;
            --secondary-subtle: #E9F6FB;
            --destructive-default: #D84265;
            --surface-subtle: #FFFFFF;
            --surface-default: #F9F8FA;
            --border-default: #9D9BA6;
            --border-light: #E7E7E9;
            --text-black: #000000;
            --text-body: #4E4D56;
            --text-description: #83818F;
            --text-disabled: #CDCCD1;
            --neutral-300: #B5B3BC;
            --surface-disabled-dark: #C2C1C8;

            /* Spacing */
            --spacing-xs: 2px;
            --spacing-s: 4px;
            --spacing-sm: 8px;
            --spacing-m: 16px;
            --spacing-ml: 20px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 40px;
            --spacing-xxxl: 48px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(-59deg, rgba(141, 61, 210, 1) 5%, rgba(233, 118, 215, 1) 81%);
            background-attachment: fixed;
            color: var(--text-black);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background-color: transparent;
            padding: 14px var(--spacing-m);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 56px;
        }

        .header-back {
            position: absolute;
            left: var(--spacing-m);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            background: transparent;
            z-index: 2;
        }

        .header-back:hover {
            opacity: 0.7;
        }

        .header-back svg {
            width: 20px;
            height: 20px;
            stroke: var(--surface-subtle);
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            line-height: 28px;
            color: var(--surface-subtle);
            text-align: center;
            width: 100%;
            z-index: 1;
        }

        /* Logo/Title Section */
        .logo-section {
            padding: 40px var(--spacing-m) 20px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }

        .logo-title {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.1666666666666667em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            text-align: left;
        }

        /* Social Auth Buttons Section */
        .social-auth-section {
            padding: 20px var(--spacing-m);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
        }

        .auth-button {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--surface-subtle);
            border: 1px solid var(--text-disabled);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2857142857142858em;
            letter-spacing: -0.006em;
            color: #1B1A1E;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: left;
            gap: 10px;
            font-family: 'Inter', sans-serif;
        }

        .auth-button:hover {
            opacity: 0.9;
        }

        .auth-button-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .auth-note {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            text-align: left;
        }

        /* Or Divider */
        .divider-section {
            padding: var(--spacing-m);
            display: flex;
            align-items: center;
            gap: var(--spacing-ml);
        }

        .divider-line {
            flex: 1;
            height: 1px;
            background-color: var(--text-disabled);
        }

        .divider-text {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.4285714285714286em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
        }

        /* Email/Mobile Link */
        .email-mobile-link-section {
            padding: var(--spacing-ml) var(--spacing-m);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-m);
        }

        .email-mobile-link {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2857142857142858em;
            letter-spacing: -0.006em;
            color: #9FDAEF;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        .email-mobile-link:hover {
            text-decoration: underline;
        }

        /* Form Section */
        .form-section {
            display: none;
            padding: 20px var(--spacing-m);
            background-color: transparent;
            margin-top: 0;
        }

        .form-section.show {
            display: block;
        }

        /* Mobile OTP Section */
        .mobile-otp-section {
            display: none;
            flex-direction: column;
            gap: var(--spacing-xl);
            padding: 0 var(--spacing-m);
            width: 100%;
            max-width: 100%;
        }

        .mobile-otp-section.show {
            display: flex;
        }

        /* OTP Verification Section */
        .otp-verification-section {
            display: none;
            flex-direction: column;
            gap: var(--spacing-xl);
            padding: 0 var(--spacing-m);
            width: 100%;
            max-width: 100%;
        }

        .otp-verification-section.show {
            display: flex;
        }

        /* OTP Instruction Text */
        .otp-instruction-text {
            padding: 0;
            width: 100%;
        }

        .otp-instruction-text p {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            text-align: left;
            margin: 0;
            word-wrap: break-word;
        }

        /* Mobile OTP Title Section */
        .mobile-otp-title-section {
            padding: 20px 0 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }

        .mobile-otp-title {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.1666666666666667em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            text-align: left;
            margin: 0;
        }

        /* Mobile Input Container */
        .mobile-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
            width: 100%;
        }

        .mobile-input-flag {
            width: 25px;
            height: 18px;
            flex-shrink: 0;
        }

        .mobile-input-number {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            line-height: 18px;
            letter-spacing: -0.006em;
            color: var(--text-body);
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .mobile-input-number::placeholder {
            color: var(--neutral-300);
        }

        /* OTP Section */
        .otp-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
        }

        .otp-label {
            font-size: 14px;
            font-weight: 500;
            line-height: 18px;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
        }

        .otp-inputs {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .otp-input {
            width: 58px;
            height: 58px;
            padding: 0;
            background-color: var(--surface-subtle);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            font-size: 24px;
            font-weight: 600;
            line-height: 1;
            letter-spacing: 0;
            color: var(--text-body);
            text-align: center;
            outline: none;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            aspect-ratio: 1;
        }

        .otp-input:focus {
            border-color: var(--secondary-default);
            box-shadow: 0 0 0 2px var(--secondary-subtle);
        }

        /* Buttons */
        .btn-send-otp,
        .btn-verify-otp {
            width: 100%;
            padding: 12px var(--spacing-m);
            background-color: var(--text-disabled);
            color: var(--text-description);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            line-height: 18px;
            letter-spacing: -0.006em;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        .btn-send-otp:not(:disabled),
        .btn-verify-otp:not(:disabled) {
            background-color: var(--primary-default);
            color: var(--surface-subtle);
        }

        .btn-send-otp:hover:not(:disabled),
        .btn-verify-otp:hover:not(:disabled) {
            background-color: var(--primary-darker);
        }

        .btn-send-otp:disabled,
        .btn-verify-otp:disabled {
            cursor: not-allowed;
        }

        /* Button Container */
        .button-container,
        .button-container-send {
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
            width: 100%;
            box-sizing: border-box;
        }

        .button-container {
            padding-top: var(--spacing-xxl);
            padding-bottom: var(--spacing-xxl);
        }

        /* Resend OTP Text */
        .resend-otp-text {
            color: #73C8E7;
            font-size: 14px;
            font-weight: 500;
            line-height: 18px;
            letter-spacing: -0.006em;
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: 'Inter', sans-serif;
            text-align: center;
            user-select: none;
        }

        .resend-otp-text:hover:not(.disabled) {
            opacity: 0.8;
        }

        .resend-otp-text.disabled {
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        /* Main Container */
        .container {
            flex: 1;
            padding: 0;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Form Fields */
        .form-group {
            margin-bottom: var(--spacing-m);
            width: 100%;
        }

        .form-group:last-of-type {
            margin-bottom: 0;
        }

        .input-label {
            font-size: 10px;
            font-weight: 600;
            line-height: 1.4em;
            color: var(--secondary-default);
            margin-bottom: 4px;
            display: block;
            width: 100%;
        }

        .input-field {
            width: 100%;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            color: var(--text-body);
            background-color: var(--surface-subtle);
            border: 1px solid #9D9BA6;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            height: 58px;
        }

        .input-field::placeholder {
            color: #B5B3BC;
            font-weight: 500;
        }

        .input-field:focus {
            border-color: var(--secondary-default);
            box-shadow: 0 0 0 2px var(--secondary-subtle);
        }

        /* Mobile Input with Country Code */
        .mobile-input-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 1px solid #9D9BA6;
            border-radius: 8px;
            background-color: var(--surface-subtle);
            padding: 8px 16px;
            width: 100%;
            box-sizing: border-box;
            min-height: 58px;
            overflow: hidden;
        }

        .mobile-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            flex: 1;
        }

        .mobile-input-inline-label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            line-height: 1.4em;
            letter-spacing: -0.006em;
            color: var(--secondary-default);
        }

        /* Form Reminder Section */
        .form-reminder {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 8px;
            width: 100%;
            margin-top: 0;
        }

        .reminder-emoji {
            font-size: 14px;
            line-height: 1.2857142857142858em;
            flex-shrink: 0;
        }

        .reminder-text {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            flex: 1;
        }

        .country-code-selector {
            display: flex;
            align-items: center;
            padding: 0;
            background-color: transparent;
            border: none;
            cursor: pointer;
            min-width: 80px;
            gap: 4px;
            flex-shrink: 0;
            height: 18px;
            min-height: 18px;
            color: inherit;
            font: inherit;
        }

        .country-code-selector:hover {
            background-color: var(--surface-default);
        }

        .country-flag {
            font-size: 18px;
        }

        .country-code-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-body);
        }

        .country-dropdown-icon {
            font-size: 8px;
            color: var(--text-description);
            margin-top: 2px;
        }

        .mobile-input-field,
        .mobile-input-number {
            flex: 1;
            border: none;
            padding: 0;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            color: var(--text-body);
            background-color: transparent;
            outline: none;
            font-family: 'Inter', sans-serif;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
            height: 18px;
            min-height: 18px;
        }

        .mobile-input-field::placeholder,
        .mobile-input-number::placeholder {
            color: #B5B3BC;
            font-weight: 500;
        }

        .mobile-input-container:focus-within {
            border-color: var(--secondary-default);
            box-shadow: 0 0 0 2px var(--secondary-subtle);
        }

        /* Error Message */
        .error-message {
            font-size: 16px;
            font-weight: 500;
            line-height: 24px;
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 12px;
            display: none;
            width: 100%;
            word-wrap: break-word;
            padding: 0 var(--spacing-xs);
        }

        .error-message.show {
            display: block;
        }

        /* Success Message */
        .success-message {
            font-size: 16px;
            font-weight: 500;
            line-height: 24px;
            color: var(--secondary-default);
            text-align: center;
            margin-bottom: 12px;
            display: none;
            width: 100%;
            word-wrap: break-word;
            padding: 0 var(--spacing-xs);
        }

        .success-message.show {
            display: block;
        }

        /* Country Picker Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-m);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--surface-subtle);
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        }

        /* Social Auth Instructions Section */
        .social-auth-instructions-section,
        .success-section {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: var(--spacing-m);
            min-height: calc(100vh - 56px);
            justify-content: center;
            align-items: center;
        }

        .social-auth-instructions-section.show,
        .success-section.show {
            display: flex;
        }

        .social-auth-modal-body,
        .success-modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xl);
            width: 100%;
            padding: var(--spacing-xl) 0;
        }

        .social-auth-icon-container,
        .success-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0;
        }

        .social-auth-icon,
        .success-icon {
            width: 288px;
            height: 288px;
            object-fit: contain;
        }

        .social-auth-text-container,
        .success-text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-m);
            width: 100%;
            max-width: 600px;
            padding: 0 var(--spacing-m);
            box-sizing: border-box;
        }

        .social-auth-title,
        .success-title {
            font-size: 24px;
            font-weight: 700;
            line-height: 28px;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            margin: 0;
            text-align: center;
            width: 100%;
        }

        .social-auth-description,
        .success-description {
            font-size: 14px;
            font-weight: 500;
            line-height: 18px;
            letter-spacing: -0.006em;
            color: var(--surface-subtle);
            margin: 0;
            max-width: 100%;
            text-align: left;
            width: 100%;
        }

        .app-store-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
        }

        .app-store-link {
            display: inline-block;
            text-decoration: none;
            transition: opacity 0.2s, transform 0.2s;
        }

        .app-store-link:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .app-store-button {
            width: 181px;
            height: auto;
            cursor: pointer;
            display: block;
            transition: opacity 0.2s;
        }

        /* Device-specific button visibility */
        .app-store-link.hide-on-device {
            display: none;
        }

        /* Show only relevant button on mobile devices */
        .device-android .app-store-link.ios-only {
            display: none;
        }

        .device-ios .app-store-link.android-only {
            display: none;
        }

        .device-desktop .app-store-link,
        .device-mobile .app-store-link {
            display: inline-block;
        }

        /* Responsive styles for social auth instructions and success section */
        @media (max-width: 767px) {

            .social-auth-instructions-section,
            .success-section {
                padding: var(--spacing-m);
            }

            .social-auth-modal-body,
            .success-modal-body {
                padding: var(--spacing-m) 0;
                gap: var(--spacing-xl);
            }

            .social-auth-icon-container,
            .success-icon-container {
                padding: 0;
            }

            .social-auth-icon,
            .success-icon {
                width: 216px;
                height: 216px;
            }

            .social-auth-title,
            .success-title {
                font-size: 20px;
                line-height: 24px;
            }

            .social-auth-description,
            .success-description {
                font-size: 13px;
                line-height: 18px;
                padding: 0 var(--spacing-xs);
            }

            .app-store-button {
                width: 160px;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {

            .social-auth-instructions-section,
            .success-section {
                padding: var(--spacing-xl);
            }

            .social-auth-icon,
            .success-icon {
                width: 256px;
                height: 256px;
            }

            .app-store-button {
                width: 170px;
            }
        }

        @media (min-width: 1024px) {

            .social-auth-instructions-section,
            .success-section {
                padding: var(--spacing-xxl);
            }

            .social-auth-icon,
            .success-icon {
                width: 288px;
                height: 288px;
            }

            .app-store-button {
                width: 181px;
            }
        }

        .modal-header {
            padding: var(--spacing-m);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            line-height: 28px;
            color: var(--text-black);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-description);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-body);
        }

        .modal-search {
            padding: var(--spacing-m);
            border-bottom: 1px solid var(--border-light);
        }

        .modal-search-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            color: var(--text-body);
            background-color: var(--surface-default);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .modal-search-input:focus {
            border-color: var(--secondary-default);
            box-shadow: 0 0 0 2px var(--secondary-subtle);
        }

        .modal-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm) 0;
        }

        .country-item {
            padding: 12px var(--spacing-m);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .country-item:hover {
            background-color: var(--surface-default);
        }

        .country-item-flag {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .country-item-flag-img {
            width: 21px;
            height: 15px;
            object-fit: contain;
            display: inline-block;
        }

        .country-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .country-item-name {
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            color: var(--text-body);
        }

        .country-item-code {
            font-size: 12px;
            font-weight: 500;
            line-height: 18px;
            color: var(--text-description);
        }

        /* Button */
        .btn-primary {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--primary-default);
            color: var(--surface-subtle);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2857142857142858em;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-darker);
        }

        .btn-primary:disabled {
            background-color: #CDCCD1;
            color: #83818F;
            cursor: not-allowed;
        }

        /* Button Section */
        .button-section {
            padding: 40px 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Footer */
        .footer {
            text-align: center;
            width: 100%;
            padding: 0;
        }

        .footer-text {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2857142857142858em;
            color: #9FDAEF;
            display: inline;
            word-wrap: break-word;
        }

        .footer-link {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.2857142857142858em;
            color: #9FDAEF;
            text-decoration: none;
            display: inline;
            cursor: pointer;
            word-wrap: break-word;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        /* Responsive Design */

        /* Mobile-first: Base styles are for mobile */
        /* Small mobile devices (up to 374px) */
        @media (max-width: 374px) {
            html {
                overflow-x: hidden;
            }

            body {
                transform: scale(0.9);
                transform-origin: top center;
                width: 100vw;
                overflow-x: hidden;
            }

            .logo-title {
                font-size: 20px;
                line-height: 24px;
            }

            .mobile-otp-title {
                font-size: 20px;
                line-height: 24px;
            }

            .auth-button {
                font-size: 13px;
                padding: 10px var(--spacing-m);
            }

            .footer-text,
            .footer-link {
                font-size: 16px;
                line-height: 24px;
            }

            .otp-input {
                width: 48px;
                height: 48px;
                padding: 0;
                font-size: 18px;
                font-weight: 600;
            }

            .form-group {
                margin-bottom: var(--spacing-sm);
            }

            .input-label {
                font-size: 13px;
                line-height: 20px;
            }

            .input-field {
                padding: 12px var(--spacing-sm);
                font-size: 16px;
            }

            .country-code-selector {
                padding: 12px var(--spacing-xs);
                min-width: 80px;
            }

            .country-code-text {
                font-size: 11px;
            }

            .btn-primary {
                padding: 12px var(--spacing-xs);
                height: 48px;
                font-size: 14px;
                margin-top: var(--spacing-l);
            }

            .error-message,
            .success-message {
                font-size: 13px;
                line-height: 18px;
            }
        }

        /* Mobile devices (375px to 767px) */
        @media (min-width: 375px) and (max-width: 767px) {
            .container {
                padding: 0;
            }

            .logo-section {
                padding: 32px var(--spacing-m) 16px;
            }

            .social-auth-section {
                padding: var(--spacing-m) var(--spacing-m);
            }

            .email-mobile-link-section {
                padding: var(--spacing-m) var(--spacing-m);
            }

            .mobile-otp-section {
                padding: 0 var(--spacing-m);
            }

            .button-container {
                padding-top: var(--spacing-xl);
                padding-bottom: var(--spacing-xl);
            }

            .button-container-send {
                padding: 0;
            }
        }

        /* Mobile-only optimizations */
        @media (max-width: 767px) {
            html {
                overflow-x: hidden;
            }

            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
                transform: scale(0.95);
                transform-origin: top center;
                width: 100vw;
                overflow-x: hidden;
            }

            .container {
                width: 100%;
                max-width: 100%;
            }

            .logo-section {
                padding: 40px var(--spacing-m) 20px;
            }

            .logo-title {
                font-size: 24px;
                line-height: 1.1666666666666667em;
            }

            .mobile-otp-title {
                font-size: 24px;
                line-height: 1.1666666666666667em;
            }

            .social-auth-section {
                padding: 20px var(--spacing-m);
                gap: var(--spacing-m);
            }

            .auth-button {
                padding: 12px 16px;
                font-size: 14px;
            }

            .auth-button-icon {
                width: 20px;
                height: 20px;
            }

            .auth-note {
                font-size: 14px;
                line-height: 1.2857142857142858em;
            }

            .divider-section {
                padding: var(--spacing-m);
                gap: var(--spacing-ml);
            }

            .divider-text {
                font-size: 14px;
                line-height: 1.4285714285714286em;
            }

            .email-mobile-link {
                font-size: 14px;
                line-height: 1.2857142857142858em;
            }

            .mobile-input-number {
                font-size: 16px;
            }

            .otp-label {
                font-size: 13px;
            }

            .otp-input {
                width: 52px;
                height: 52px;
                font-size: 20px;
                font-weight: 600;
            }

            .btn-send-otp,
            .btn-verify-otp {
                padding: 14px var(--spacing-m);
                font-size: 15px;
            }

            .form-section {
                padding: 20px var(--spacing-m);
                padding-bottom: max(24px, env(safe-area-inset-bottom));
                background-color: transparent;
            }

            .form-reminder {
                gap: 8px;
            }

            .reminder-text {
                font-size: 14px;
                line-height: 1.2857142857142858em;
            }

            .form-group {
                margin-bottom: var(--spacing-m);
            }

            .form-group:last-of-type {
                margin-bottom: 0;
            }

            .input-label {
                font-size: 10px;
                line-height: 1.4em;
                margin-bottom: 4px;
            }

            .input-field {
                padding: 8px 16px;
                font-size: 14px;
                line-height: 1.2857142857142858em;
                height: 58px;
            }

            .mobile-input-container {
                padding: 8px 16px;
                min-height: 58px;
            }

            .mobile-input-field {
                font-size: 14px;
                line-height: 1.2857142857142858em;
            }

            .country-code-selector {
                padding: 0;
                min-width: 80px;
                height: 18px;
                min-height: 18px;
            }

            .country-code-text {
                font-size: 13px;
            }

            .button-section {
                padding: 40px 0;
                gap: 14px;
            }

            .btn-primary {
                padding: 12px 16px;
                font-size: 14px;
                line-height: 1.2857142857142858em;
                border-radius: 8px;
            }

            .error-message,
            .success-message {
                font-size: 14px;
                line-height: 20px;
                margin-bottom: var(--spacing-sm);
                padding: 0 var(--spacing-xs);
            }

            .footer-text,
            .footer-link {
                font-size: 14px;
                line-height: 1.2857142857142858em;
            }

            .modal-content {
                max-width: calc(100% - 32px);
                margin: var(--spacing-m);
            }

            .modal-header {
                padding: var(--spacing-sm) var(--spacing-m);
            }

            .modal-title {
                font-size: 16px;
            }
        }

        /* Tablet devices (768px to 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .container {
                max-width: 600px;
                padding: 0;
            }

            .logo-section {
                padding: 40px var(--spacing-xl) 20px;
            }

            .social-auth-section,
            .email-mobile-link-section {
                padding: var(--spacing-ml) var(--spacing-xl);
            }

            .mobile-otp-section {
                padding: 0 var(--spacing-xl);
            }

            .mobile-input-wrapper {
                gap: var(--spacing-xs);
            }

            .form-section {
                padding: var(--spacing-xl);
                border-radius: 16px 16px 0 0;
            }

            .form-group {
                margin-bottom: var(--spacing-m);
            }

            .form-group:last-of-type {
                margin-bottom: var(--spacing-xl);
            }

            .input-label {
                font-size: 15px;
                line-height: 24px;
            }

            .input-field {
                padding: 13px var(--spacing-m);
                font-size: 16px;
            }

            .country-code-selector {
                padding: 13px var(--spacing-sm);
                min-width: 95px;
                height: 18px;
                min-height: 18px;
            }

            .btn-primary {
                padding: 13px var(--spacing-sm);
                height: 50px;
                font-size: 15px;
            }

            .otp-input {
                width: 56px;
                height: 56px;
                font-size: 22px;
            }

            .button-container {
                padding-top: var(--spacing-xxl);
                padding-bottom: var(--spacing-xxl);
            }

            .button-container-send {
                padding: 0;
            }

            .modal-content {
                max-width: 450px;
            }
        }

        /* Desktop devices (1024px and up) */
        @media (min-width: 1024px) {
            .container {
                max-width: 600px;
                padding: 0;
            }

            .logo-section {
                padding: 48px var(--spacing-xl) 24px;
            }

            .social-auth-section,
            .email-mobile-link-section {
                padding: var(--spacing-xl) var(--spacing-xl);
            }

            .mobile-otp-section {
                padding: 0 var(--spacing-xl);
                gap: var(--spacing-xxl);
            }

            .form-section {
                padding: var(--spacing-xxl);
                border-radius: 20px 20px 0 0;
            }

            .form-group {
                margin-bottom: var(--spacing-m);
            }

            .form-group:last-of-type {
                margin-bottom: var(--spacing-xl);
            }

            .input-label {
                font-size: 16px;
                line-height: 26px;
            }

            .input-field {
                padding: 12px var(--spacing-m);
                font-size: 16px;
            }

            .country-code-selector {
                padding: 12px var(--spacing-sm);
                min-width: 100px;
                height: 18px;
                min-height: 18px;
            }

            .btn-primary {
                padding: 12px var(--spacing-sm);
                height: 48px;
                font-size: 14px;
            }

            .error-message,
            .success-message {
                font-size: 16px;
                line-height: 24px;
            }

            .otp-input {
                width: 58px;
                height: 58px;
                font-size: 24px;
            }

            .button-container {
                padding-top: var(--spacing-xxxl);
                padding-bottom: var(--spacing-xxxl);
            }

            .button-container-send {
                padding: 0;
            }

            .auth-button:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .btn-send-otp:hover:not(:disabled),
            .btn-verify-otp:hover:not(:disabled),
            .btn-primary:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 38, 140, 0.3);
            }

            .modal-content {
                max-width: 500px;
            }
        }

        /* Large desktop devices (1440px and up) */
        @media (min-width: 1440px) {
            .container {
                max-width: 700px;
            }

            .logo-section {
                padding: 56px var(--spacing-xxl) 32px;
            }

            .social-auth-section,
            .email-mobile-link-section {
                padding: var(--spacing-xxl) var(--spacing-xxl);
            }

            .mobile-otp-section {
                padding: 0 var(--spacing-xxl);
            }

            .form-section {
                padding: var(--spacing-xxxl) var(--spacing-xxl);
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 767px) and (orientation: landscape) {
            .logo-section {
                padding: 20px var(--spacing-m) 12px;
            }

            .logo-title {
                font-size: 20px;
                line-height: 24px;
            }

            .mobile-otp-title {
                font-size: 20px;
                line-height: 24px;
            }

            .social-auth-section {
                padding: var(--spacing-sm) var(--spacing-m);
                gap: var(--spacing-xs);
            }

            .mobile-otp-section {
                gap: var(--spacing-m);
            }

            .button-container {
                padding-top: var(--spacing-m);
                padding-bottom: var(--spacing-m);
            }

            .button-container-send {
                padding: 0;
            }

            .form-section {
                padding: var(--spacing-sm) var(--spacing-m);
            }

            .form-group {
                margin-bottom: var(--spacing-xs);
            }

            .form-group:last-of-type {
                margin-bottom: var(--spacing-sm);
            }

            .input-label {
                font-size: 13px;
                line-height: 20px;
                margin-bottom: var(--spacing-xs);
            }

            .input-field {
                padding: 10px var(--spacing-m);
                font-size: 16px;
            }

            .btn-primary {
                padding: 10px var(--spacing-sm);
                height: 44px;
                margin-top: var(--spacing-m);
                margin-bottom: var(--spacing-sm);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {

            .auth-button,
            .btn-send-otp,
            .btn-verify-otp,
            .btn-primary {
                min-height: 48px;
            }

            .header-back {
                min-width: 44px;
                min-height: 44px;
            }

            .country-code-selector {
                min-height: 18px;
            }

            .input-field {
                min-height: 48px;
            }

            .otp-input {
                min-width: 48px;
                min-height: 48px;
            }
        }

        /* Prevent iOS zoom on input focus */
        @media (max-width: 767px) {

            .input-field,
            .otp-input,
            .modal-search-input {
                font-size: 16px !important;
            }
        }

        /* Safe area support for notched devices */
        @supports (padding: max(0px)) {
            @media (max-width: 767px) {
                .logo-section {
                    padding-left: max(var(--spacing-m), env(safe-area-inset-left));
                    padding-right: max(var(--spacing-m), env(safe-area-inset-right));
                }

                .social-auth-section,
                .email-mobile-link-section {
                    padding-left: max(var(--spacing-m), env(safe-area-inset-left));
                    padding-right: max(var(--spacing-m), env(safe-area-inset-right));
                }

                .form-section {
                    padding-left: max(var(--spacing-m), env(safe-area-inset-left));
                    padding-right: max(var(--spacing-m), env(safe-area-inset-right));
                    padding-bottom: max(24px, env(safe-area-inset-bottom));
                }

                .mobile-otp-section,
                .success-section {
                    padding-left: max(var(--spacing-m), env(safe-area-inset-left));
                    padding-right: max(var(--spacing-m), env(safe-area-inset-right));
                }

                .button-container {
                    padding-bottom: max(var(--spacing-xxl), env(safe-area-inset-bottom));
                }
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            .mobile-input-flag,
            .auth-button-icon {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <!-- <header class="header">
        <button class="header-back" onclick="handleBack()" aria-label="Go back">
            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <h1 class="header-title">Sign up</h1>
    </header> -->

    <!-- Main Content -->
    <main class="container">
        <!-- Logo Section -->
        <div id="logoSection" class="logo-section">
            <h1 class="logo-title">Sali na sa Domo!</h1>
        </div>

        <!-- Social Auth Buttons Section -->
        <div id="socialAuthButtonsSection" class="social-auth-section">
            <button class="auth-button" id="googleAuthButton" onclick="beginProviderSignupWithOtp('google')">
                <img src="google-icon.svg" alt="Google" class="auth-button-icon" />
                <span>Direktang sign-up gamit Google</span>
            </button>
            <button class="auth-button" id="facebookAuthButton" onclick="beginProviderSignupWithOtp('facebook')" style="display: none;">
                <img src="facebook-icon.svg" alt="Facebook" class="auth-button-icon" />
                <span>Direktang sign-up gamit FB</span>
            </button>
            <button class="auth-button" id="appleAuthButton" onclick="beginProviderSignupWithOtp('apple')">
                <img src="apple-icon.svg" alt="Apple" class="auth-button-icon" />
                <span>Direktang sign-up gamit Apple</span>
            </button>
            <p class="auth-note">Paalala: Ito ang magiging account mo para makapag-login sa app.</p>
        </div>

        <!-- Or Divider -->
        <div id="dividerSection" class="divider-section">
            <div class="divider-line"></div>
            <span class="divider-text">Or</span>
            <div class="divider-line"></div>
        </div>

        <!-- Email/Mobile Link Section -->
        <div id="emailMobileLinkSection" class="email-mobile-link-section">
            <button class="email-mobile-link" onclick="showEmailMobileForm()">Gamitin email/mobile nalang</button>
        </div>

        <!-- Mobile OTP Section (Initially Hidden) -->
        <div id="mobileOtpSection" class="mobile-otp-section">
            <!-- Title Section -->
            <div class="mobile-otp-title-section">
                <h1 class="mobile-otp-title">Anong ginagamit mong mobile number?</h1>
            </div>

            <!-- Error Message -->
            <div id="errorMessageOtp" class="error-message" role="alert"></div>

            <!-- Success Message -->
            <div id="successMessageOtp" class="success-message" role="status"></div>

            <!-- Mobile Input -->
            <div class="mobile-input-wrapper">
                <div class="mobile-input-container">
                    <label class="mobile-input-inline-label" for="mobileOtpInput">Mobile No.</label>
                    <div class="mobile-input-row">
                        <button type="button" class="country-code-selector" id="countrySelectorOtp"
                            onclick="toggleCountryPicker()">
                            <img src="flag-icons/ph.svg" alt="Philippines" class="mobile-input-flag"
                                id="mobileOtpFlagImg" />
                            <span class="country-code-text" id="mobileOtpCode">+63</span>
                            <span class="country-dropdown-icon">â–¼</span>
                        </button>
                        <input type="tel" id="mobileOtpInput" class="mobile-input-number" placeholder="912 345 6789"
                            autocomplete="tel" />
                    </div>
                </div>
            </div>
            <div class="button-container-send">
                <button type="button" id="sendOtpButton" class="btn-send-otp" disabled>Send OTP</button>
            </div>
        </div>

        <!-- OTP Verification Section (Initially Hidden) -->
        <div id="otpVerificationSection" class="otp-verification-section">
            <!-- Title Section -->
            <div class="mobile-otp-title-section">
                <h1 class="mobile-otp-title">Verify natin ang mobile!</h1>
            </div>

            <!-- Error Message -->
            <div id="errorMessageOtpVerify" class="error-message" role="alert"></div>

            <!-- Success Message -->
            <div id="successMessageOtpVerify" class="success-message" role="status"></div>

            <!-- OTP Input Section -->
            <div class="otp-section">
                <label class="otp-label">One time PIN:</label>
                <div class="otp-inputs">
                    <input type="text" id="otp1" class="otp-input" maxlength="1" inputmode="numeric"
                        autocomplete="one-time-code" />
                    <input type="text" id="otp2" class="otp-input" maxlength="1" inputmode="numeric"
                        autocomplete="one-time-code" />
                    <input type="text" id="otp3" class="otp-input" maxlength="1" inputmode="numeric"
                        autocomplete="one-time-code" />
                    <input type="text" id="otp4" class="otp-input" maxlength="1" inputmode="numeric"
                        autocomplete="one-time-code" />
                </div>
            </div>

            <!-- Resend OTP Button -->
            <div class="button-container-send">
                <span id="resendOtpButton" class="resend-otp-text disabled">Resend in 0s</span>
            </div>

            <!-- Instruction Text -->
            <div class="otp-instruction-text">
                <p id="otpInstructionText">Nag-send kami ng OTP sa +63 917 123 4567. Ilagay lang sa taas para ma-verify ang number mo.</p>
            </div>

            <!-- Verify OTP Button -->
            <div class="button-container">
                <button type="button" id="verifyOtpButton" class="btn-verify-otp" disabled>Verify</button>
            </div>
        </div>

        <!-- Form Section (Initially Hidden) -->
        <div id="formSection" class="form-section">
            <form id="signupForm" onsubmit="handleSignup(event)">
                <!-- Email or Mobile Field -->
                <div class="form-group">
                    <div class="mobile-input-container">
                        <label for="mobile" class="mobile-input-inline-label">Email or mobile</label>
                        <div class="mobile-input-row">
                            <button type="button" class="country-code-selector" id="countrySelector"
                                onclick="toggleCountryPicker()">
                                <img src="flag-icons/ph.svg" alt="Philippines" class="mobile-input-flag"
                                    id="countryFlagImg" />
                                <span class="country-code-text" id="countryCode">+63</span>
                                <span class="country-dropdown-icon">â–¼</span>
                            </button>
                            <input type="text" id="mobile" name="mobile" class="mobile-input-field"
                                placeholder="917 123 4567" autocomplete="username" required />
                        </div>
                    </div>
                </div>

                <!-- Password Field -->
                <div class="form-group">
                    <div class="mobile-input-container">
                        <label for="password" class="mobile-input-inline-label">Gumawa ng password</label>
                        <div class="mobile-input-row">
                            <input type="password" id="password" name="password" class="mobile-input-field"
                                autocomplete="new-password" required />
                        </div>
                    </div>
                </div>

                <!-- Reminder Section -->
                <div class="form-reminder">
                    <span class="reminder-emoji">ðŸŽ‰</span>
                    <span class="reminder-text">Paalala: Ito ang magiging account mo para makapag-login sa app</span>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="error-message" role="alert"></div>

                <!-- Success Message -->
                <div id="successMessage" class="success-message" role="status"></div>

            </form>

            <!-- Button Section -->
            <div class="button-section">
                <button type="submit" id="submitButton" class="btn-primary" form="signupForm">
                    Sumali na
                </button>
                <!-- Footer -->
                <footer class="footer">
                    <span class="footer-text">
                        <a href="#" class="footer-link" id="backToMainButton"
                            onclick="showMainContent(); return false;">Iba pang paraan sa sign-up</a>
                    </span>
                </footer>
            </div>
        </div>

        <!-- Social Auth Instructions Section (Initially Hidden) -->
        <div id="socialAuthSection" class="social-auth-instructions-section">
            <div class="social-auth-modal-body">
                <div class="social-auth-icon-container">
                    <img src="social-auth-icon.svg" alt="Social Auth" class="social-auth-icon" />
                </div>
                <div class="social-auth-text-container">
                    <h2 class="social-auth-title">Direktang sign-up</h2>
                    <p class="social-auth-description">
                        1-tap sign-up sa loob ng app. Gamitin lang ang Continue with Google/Apple/FB.<br><br>
                        Saglit lang at i-reredirect kita sa download sa loob ng 5 segundo. Para pumunta agad, mag-tap
                        lang sa button sa baba.
                    </p>
                    <div class="app-store-buttons">
                        <a href="https://apps.apple.com/ph/app/domo-household-manage-helpers/id6742123375"
                            target="_blank" rel="noopener noreferrer" class="app-store-link ios-only">
                            <img src="app-store-button.png" alt="Download on App Store" class="app-store-button" />
                        </a>
                        <a href="https://play.google.com/store/apps/details?id=com.domohousehold" target="_blank"
                            rel="noopener noreferrer" class="app-store-link android-only">
                            <img src="google-play-button.png" alt="Get it on Google Play" class="app-store-button" />
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Section (Initially Hidden) -->
        <div id="successSection" class="success-section">
            <div class="success-modal-body">
                <div class="success-icon-container">
                    <img src="social-auth-icon.svg" alt="Success" class="success-icon" />
                </div>
                <div class="success-text-container">
                    <h2 class="success-title">Nakaregister na tayo!</h2>
                    <p class="success-description">
                        Susunod, i-dadownload natin ang app sa App Store.<br><br>
                        Saglit lang at i-reredirect kita sa download sa loob ng 5 segundo. Para pumunta agad, mag-tap lang sa button sa baba.
                    </p>
                    <div class="app-store-buttons">
                        <a href="https://play.google.com/store/apps/details?id=com.domohousehold" target="_blank"
                            rel="noopener noreferrer" class="app-store-link android-only">
                            <img src="google-play-button.png" alt="Get it on Google Play" class="app-store-button" />
                        </a>
                        <a href="https://apps.apple.com/ph/app/domo-household-manage-helpers/id6742123375"
                            target="_blank" rel="noopener noreferrer" class="app-store-link">
                            <img src="app-store-button.png" alt="Download on App Store" class="app-store-button" />
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Country Picker Modal -->
    <div id="countryModal" class="modal-overlay" onclick="closeCountryModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Select Country</h2>
                <button class="modal-close" onclick="closeCountryModal()" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-search">
                <input type="text" id="countrySearch" class="modal-search-input" placeholder="Search countries..."
                    autocomplete="off" />
            </div>
            <div class="modal-list" id="countryList"></div>
        </div>
    </div>

    <!-- Supabase JS (for web OAuth) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        // Set your Supabase URL and anon key here or via window globals
        const SUPABASE_URL = window.SUPABASE_URL || 'https://vampznzoubbljcdadzoo.supabase.co';
        window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhbXB6bnpvdWJibGpjZGFkem9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MzA4NTUsImV4cCI6MjA2NjMwNjg1NX0.WYloMLIileC4uv1Fb40AZdybUy2NRlGOyZac5PSTxBc';

        // Validate configuration on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY === 'your-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhbXB6bnpvdWJibGpjZGFkem9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MzA4NTUsImV4cCI6MjA2NjMwNjg1NX0.WYloMLIileC4uv1Fb40AZdybUy2NRlGOyZac5PSTxBc') {
                console.error('Supabase anon key not configured. Please set window.SUPABASE_ANON_KEY');
                const errorMsg = document.getElementById('errorMessage');
                if (errorMsg) {
                    errorMsg.textContent = 'Configuration error: Supabase anon key not set. Please contact support.';
                    errorMsg.classList.add('show');
                }
            }
        });

        // Supabase Edge Function endpoints
        const SIGNUP_ENDPOINT = `${SUPABASE_URL}/functions/v1/signup-user`;
        const SEND_VERIFICATION_CODE_ENDPOINT = `${SUPABASE_URL}/functions/v1/send-verification-code`;
        const VERIFY_CODE_ENDPOINT = `${SUPABASE_URL}/functions/v1/verify-code`;
        const CHECK_STAFF_INVITE_ENDPOINT = 'https://vampznzoubbljcdadzoo.supabase.co/functions/v1/check-staff-invite';
        const VALIDATE_MOBILE_NUMBER_ENDPOINT = 'https://vampznzoubbljcdadzoo.supabase.co/functions/v1/validate-mobile-number';

        try { console.log('Signup script initialized'); } catch (_) { }

        // Form validation and state
        const form = document.getElementById('signupForm');
        const mobileInput = document.getElementById('mobile');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const submitButton = document.getElementById('submitButton');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const countryCodeText = document.getElementById('countryCode');
        const countryFlag = document.getElementById('countryFlag');
        const countrySelector = document.getElementById('countrySelector');
        const countryFlagImg = document.getElementById('countryFlagImg');
        // Bind country selector immediately (don't rely solely on DOMContentLoaded)
        if (countrySelector) {
            countrySelector.setAttribute('role', 'button');
            countrySelector.setAttribute('tabindex', '0');
            countrySelector.setAttribute('aria-haspopup', 'listbox');
            countrySelector.setAttribute('aria-expanded', 'false');
            countrySelector.addEventListener('click', (e) => {
                e.preventDefault();
                toggleCountryPicker();
            });
            countrySelector.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleCountryPicker();
                }
            });
        }

        // Country code selection (defaults to Philippines)
        let selectedCountryCode = '+63';
        let selectedCountryFlag = 'ðŸ‡µðŸ‡­';
        let selectedCountryCode_iso = 'PH';
        let pendingSignupData = null;
        let currentVerifyingMobileNumber = null; // Store mobile number being verified for resend
        let isProcessingOAuth = false; // Flag to prevent concurrent OAuth processing

        // Common countries list (matching React Native MobileInput)
        const countries = [
            { code: 'PH', name: 'Philippines', callingCode: '+63', flag: 'ðŸ‡µðŸ‡­' },
            { code: 'US', name: 'United States', callingCode: '+1', flag: 'ðŸ‡ºðŸ‡¸' },
            { code: 'GB', name: 'United Kingdom', callingCode: '+44', flag: 'ðŸ‡¬ðŸ‡§' },
            { code: 'CA', name: 'Canada', callingCode: '+1', flag: 'ðŸ‡¨ðŸ‡¦' },
            { code: 'AU', name: 'Australia', callingCode: '+61', flag: 'ðŸ‡¦ðŸ‡º' },
            { code: 'SG', name: 'Singapore', callingCode: '+65', flag: 'ðŸ‡¸ðŸ‡¬' },
            { code: 'MY', name: 'Malaysia', callingCode: '+60', flag: 'ðŸ‡²ðŸ‡¾' },
            { code: 'JP', name: 'Japan', callingCode: '+81', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'KR', name: 'South Korea', callingCode: '+82', flag: 'ðŸ‡°ðŸ‡·' },
            { code: 'CN', name: 'China', callingCode: '+86', flag: 'ðŸ‡¨ðŸ‡³' },
            { code: 'IN', name: 'India', callingCode: '+91', flag: 'ðŸ‡®ðŸ‡³' },
            { code: 'ID', name: 'Indonesia', callingCode: '+62', flag: 'ðŸ‡®ðŸ‡©' },
            { code: 'TH', name: 'Thailand', callingCode: '+66', flag: 'ðŸ‡¹ðŸ‡­' },
            { code: 'VN', name: 'Vietnam', callingCode: '+84', flag: 'ðŸ‡»ðŸ‡³' },
            { code: 'HK', name: 'Hong Kong', callingCode: '+852', flag: 'ðŸ‡­ðŸ‡°' },
            { code: 'TW', name: 'Taiwan', callingCode: '+886', flag: 'ðŸ‡¹ðŸ‡¼' },
            { code: 'NZ', name: 'New Zealand', callingCode: '+64', flag: 'ðŸ‡³ðŸ‡¿' },
            { code: 'DE', name: 'Germany', callingCode: '+49', flag: 'ðŸ‡©ðŸ‡ª' },
            { code: 'FR', name: 'France', callingCode: '+33', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'IT', name: 'Italy', callingCode: '+39', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'ES', name: 'Spain', callingCode: '+34', flag: 'ðŸ‡ªðŸ‡¸' },
            { code: 'NL', name: 'Netherlands', callingCode: '+31', flag: 'ðŸ‡³ðŸ‡±' },
            { code: 'BE', name: 'Belgium', callingCode: '+32', flag: 'ðŸ‡§ðŸ‡ª' },
            { code: 'CH', name: 'Switzerland', callingCode: '+41', flag: 'ðŸ‡¨ðŸ‡­' },
            { code: 'AT', name: 'Austria', callingCode: '+43', flag: 'ðŸ‡¦ðŸ‡¹' },
            { code: 'SE', name: 'Sweden', callingCode: '+46', flag: 'ðŸ‡¸ðŸ‡ª' },
            { code: 'NO', name: 'Norway', callingCode: '+47', flag: 'ðŸ‡³ðŸ‡´' },
            { code: 'DK', name: 'Denmark', callingCode: '+45', flag: 'ðŸ‡©ðŸ‡°' },
            { code: 'FI', name: 'Finland', callingCode: '+358', flag: 'ðŸ‡«ðŸ‡®' },
            { code: 'PL', name: 'Poland', callingCode: '+48', flag: 'ðŸ‡µðŸ‡±' },
            { code: 'BR', name: 'Brazil', callingCode: '+55', flag: 'ðŸ‡§ðŸ‡·' },
            { code: 'MX', name: 'Mexico', callingCode: '+52', flag: 'ðŸ‡²ðŸ‡½' },
            { code: 'AR', name: 'Argentina', callingCode: '+54', flag: 'ðŸ‡¦ðŸ‡·' },
            { code: 'ZA', name: 'South Africa', callingCode: '+27', flag: 'ðŸ‡¿ðŸ‡¦' },
            { code: 'AE', name: 'United Arab Emirates', callingCode: '+971', flag: 'ðŸ‡¦ðŸ‡ª' },
            { code: 'SA', name: 'Saudi Arabia', callingCode: '+966', flag: 'ðŸ‡¸ðŸ‡¦' },
        ];

        // Validation functions
        function validateEmail(email) {
            if (!email) return true; // Email is optional
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isEmailIdentifier(value) {
            if (!value) return false;
            return /@/.test(value) || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        }

        function getFlagImageSrc(countryIso) {
            if (!countryIso) return 'flag-icons/ph.svg';
            return `flag-icons/${countryIso.toLowerCase()}.svg`;
        }

        function validatePassword(password) {
            // Password must be at least 6 characters
            return password.length >= 6;
        }

        // Formatters for masking on blur (display-only formatting)
        function formatLocalForDisplay(value, countryIso) {
            const digits = (value || '').replace(/\D/g, '');
            if (!digits) return '';

            // Philippines formatting
            if (countryIso === 'PH') {
                // If user kept leading 0 and length is 11: 0929 260 8805 (4-3-4 grouping)
                if (digits.length === 11 && digits.startsWith('0')) {
                    return `${digits.slice(0, 4)}${digits.slice(4, 7) ? ' ' + digits.slice(4, 7) : ''}${digits.slice(7) ? ' ' + digits.slice(7) : ''}`;
                }
                // If 10 digits (no leading 0): 929 260 8805 (3-3-4 grouping)
                if (digits.length === 10) {
                    return `${digits.slice(0, 3)}${digits.slice(3, 6) ? ' ' + digits.slice(3, 6) : ''}${digits.slice(6) ? ' ' + digits.slice(6) : ''}`;
                }
            }

            // Fallback: group by 3s (e.g., 123 456 7890)
            return digits.replace(/(\d{3})(?=\d)/g, '$1 ').trim();
        }

        function validateMobile(mobile, countryCode) {
            const digits = mobile.replace(/\D/g, '');
            if (countryCode === 'PH') {
                // Philippines: should be 10 digits after removing leading zero
                const processedDigits = digits.replace(/^0+/, '');
                return processedDigits.length === 10;
            }
            // For other countries, E.164 light check: 5-15 digits
            return digits.length >= 5 && digits.length <= 15;
        }

        // Normalize phone number (matching backend logic)
        function normalizePhone(value) {
            if (!value) return null;
            // Remove all spaces and hyphens
            let v = String(value).trim().replace(/[\s-]/g, '');
            // Convert leading 00 to +
            if (v.startsWith('00')) v = `+${v.slice(2)}`;
            // Ensure Philippines local numbers are converted to +63 format (best-effort)
            if (/^0\d{10}$/.test(v)) {
                // 11-digits starting with 0 -> assume PH and convert
                v = `+63${v.slice(1)}`;
            }
            // If still no plus, but looks like country code-less, keep digits
            return v;
        }

        // Update button state based on form validity
        // Required fields: nickname, mobile number, and password
        function updateButtonState() {
            // Check if form is visible and inputs exist
            const formSection = document.getElementById('formSection');
            if (!formSection || !formSection.classList.contains('show')) {
                return;
            }

            if (!mobileInput || !passwordInput || !submitButton) {
                return;
            }

            const identifier = mobileInput.value.trim();
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput.value.trim();

            // Detect identifier type and toggle country selector visibility
            const idIsEmail = isEmailIdentifier(identifier);
            if (countrySelector) {
                countrySelector.style.display = idIsEmail ? 'none' : 'flex';
            }

            let identifierValid = false;
            if (idIsEmail) {
                identifierValid = validateEmail(identifier);
            } else {
                identifierValid = validateMobile(identifier, selectedCountryCode_iso);
            }

            const isFormValid =
                identifier &&
                password &&
                validatePassword(password) &&
                (email ? validateEmail(email) : true) &&
                identifierValid;

            submitButton.disabled = !isFormValid;
        }

        // Add input listeners (only if inputs exist)
        const formInputs = [mobileInput, emailInput, passwordInput].filter(input => input !== null);
        formInputs.forEach(input => {
            input.addEventListener('input', updateButtonState);
        });
        // Masking handlers for the unified Email/Mobile field
        if (mobileInput) {
            mobileInput.addEventListener('blur', () => {
                const val = mobileInput.value;
                if (!val) return;
                if (isEmailIdentifier(val)) return; // don't format emails
                mobileInput.value = formatLocalForDisplay(val, selectedCountryCode_iso);
            });
            mobileInput.addEventListener('focus', () => {
                // unmask to raw digits for easier editing
                const val = mobileInput.value || '';
                mobileInput.value = val.replace(/\D/g, '');
            });
            // Hide/show country code selector based on letter detection
            mobileInput.addEventListener('input', () => {
                const val = mobileInput.value || '';
                const hasLetter = /[a-zA-Z]/.test(val);
                if (countrySelector) {
                    if (hasLetter) {
                        countrySelector.style.display = 'none';
                    } else {
                        countrySelector.style.display = '';
                    }
                }
            });
        }

        // Fallback event delegation for country selector (ensures click works)
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (!target) return;
            const hit = target.closest ? target.closest('#countrySelector') : null;
            if (hit) {
                e.preventDefault();
                toggleCountryPicker();
            }
        }, true);

        // Country picker modal functions
        function toggleCountryPicker() {
            try { console.log('Opening country picker'); } catch (_) { }
            const modal = document.getElementById('countryModal');
            const searchInput = document.getElementById('countrySearch');
            if (!modal) {
                console.error('Country modal element not found');
                return;
            }
            modal.classList.add('show');
            renderCountryList();
            // Focus search input after modal opens
            if (searchInput && searchInput.focus) {
                setTimeout(() => searchInput.focus(), 100);
            }
            // a11y state
            if (countrySelector) countrySelector.setAttribute('aria-expanded', 'true');
        }
        // Expose globally for inline onclick
        window.toggleCountryPicker = toggleCountryPicker;

        function closeCountryModal(event) {
            if (event && event.target.id !== 'countryModal') return;
            const modal = document.getElementById('countryModal');
            modal.classList.remove('show');
            document.getElementById('countrySearch').value = '';
            // a11y state
            if (countrySelector) countrySelector.setAttribute('aria-expanded', 'false');
        }
        // Expose globally for inline onclick
        window.closeCountryModal = closeCountryModal;

        function selectCountry(country) {
            selectedCountryCode = country.callingCode;
            selectedCountryFlag = country.flag;
            selectedCountryCode_iso = country.code;

            countryCodeText.textContent = country.callingCode;
            if (countryFlagImg) {
                countryFlagImg.src = getFlagImageSrc(selectedCountryCode_iso);
                countryFlagImg.alt = country.name;
            }
            // Also reflect in OTP UI if present
            const mobileOtpCodeEl = document.getElementById('mobileOtpCode');
            const mobileOtpFlagImg = document.getElementById('mobileOtpFlagImg');
            if (mobileOtpCodeEl) mobileOtpCodeEl.textContent = country.callingCode;
            if (mobileOtpFlagImg) {
                mobileOtpFlagImg.src = getFlagImageSrc(selectedCountryCode_iso);
                mobileOtpFlagImg.alt = country.name;
            }

            closeCountryModal();
            updateButtonState();
        }

        function renderCountryList(searchTerm = '') {
            const countryList = document.getElementById('countryList');
            const filtered = countries.filter(country => {
                const search = searchTerm.toLowerCase();
                return country.name.toLowerCase().includes(search) ||
                    country.callingCode.includes(search) ||
                    country.code.toLowerCase().includes(search);
            });

            countryList.innerHTML = filtered.map(country => {
                const flagSrc = getFlagImageSrc(country.code);
                return `
                    <div class="country-item" data-country-code="${country.code}" role="option" aria-label="${country.name} (${country.callingCode})">
                        <img class="country-item-flag-img" src="${flagSrc}" alt="${country.name}" />
                        <div class="country-item-info">
                            <span class="country-item-name">${country.name}</span>
                            <span class="country-item-code">(${country.callingCode})</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Attach event listeners to country items
            countryList.querySelectorAll('.country-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectCountry(filtered[index]);
                });
            });
        }

        // Country search handler - initialize after DOM is loaded
        window.addEventListener('DOMContentLoaded', () => {
            const countrySearch = document.getElementById('countrySearch');
            if (countrySearch) {
                countrySearch.addEventListener('input', (e) => {
                    renderCountryList(e.target.value);
                });
            }
            // Keyboard support for country selector
            if (countrySelector) {
                countrySelector.setAttribute('role', 'button');
                countrySelector.setAttribute('tabindex', '0');
                countrySelector.setAttribute('aria-haspopup', 'listbox');
                countrySelector.setAttribute('aria-expanded', 'false');
                // Ensure click is bound even if inline onclick is blocked
                countrySelector.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleCountryPicker();
                });
                countrySelector.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleCountryPicker();
                    }
                });
            }
        });

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
            // Hide the reminder section when error is shown
            const formReminder = document.querySelector('.form-reminder');
            if (formReminder) {
                formReminder.style.display = 'none';
            }
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.remove('show');
            errorMessage.textContent = '';
            // Show the reminder section when error is hidden
            const formReminder = document.querySelector('.form-reminder');
            if (formReminder) {
                formReminder.style.display = '';
            }
        }

        // Show success message
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
        }

        // Hide success message
        function hideSuccess() {
            successMessage.classList.remove('show');
            successMessage.textContent = '';
        }

        // Handle form submission
        async function handleSignup(event) {
            event.preventDefault();
            hideError();
            hideSuccess();

            const identifier = mobileInput.value.trim();
            const idIsEmail = isEmailIdentifier(identifier);
            const password = passwordInput.value.trim();
            const extraEmail = emailInput ? emailInput.value.trim() : '';

            if (!identifier || !password) {
                showError('Please fill in all required fields (mobile and password)');
                return;
            }

            if (extraEmail && !validateEmail(extraEmail)) {
                showError('Please enter a valid email address');
                return;
            }

            if (!validatePassword(password)) {
                showError('Password must be at least 6 characters long');
                return;
            }

            // Step 3: Check for existing staff_invite using email or mobile
            // Step 4: If found, look at users table for existing record
            // Step 5: Combine the data then call signup-user
            
            submitButton.disabled = true;
            submitButton.textContent = 'Checking...';
            
            let staffInvite = null;
            let existingUser = null;
            
            // Normalize inputs (matching backend logic)
            const normalizedEmail = idIsEmail ? (extraEmail || identifier).trim().toLowerCase() : null;
            let normalizedMobile = null;
            let initialFullMobileNumber = null;
            
            if (!idIsEmail) {
                // Normalize mobile number
                let mobileDigits = identifier.replace(/\D/g, '');
                if (selectedCountryCode_iso === 'PH') {
                    mobileDigits = mobileDigits.replace(/^0+/, '');
                }
                initialFullMobileNumber = selectedCountryCode + mobileDigits;
                normalizedMobile = normalizePhone(initialFullMobileNumber);
            }
            
            // Initialize Supabase client if needed
            if (!supabaseClient) {
                initSupabase();
            }
            
            // Check staff_invite table using edge function
            if (normalizedEmail || normalizedMobile) {
                try {
                    const checkResponse = await fetch(CHECK_STAFF_INVITE_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                            'apikey': window.SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            email: normalizedEmail,
                            mobile_no: normalizedMobile || initialFullMobileNumber
                        })
                    });

                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        if (checkData.has_staff_invite) {
                            staffInvite = checkData.staff_invite;
                            console.log('Staff invite found:', staffInvite);
                        }
                        if (checkData.has_existing_user) {
                            existingUser = checkData.existing_user;
                            console.log('Existing user found:', existingUser);
                        }
                    } else {
                        const errorData = await checkResponse.json().catch(() => ({}));
                        console.warn('Check staff invite returned error:', errorData);
                    }
                } catch (checkError) {
                    console.error('Error checking staff invite:', checkError);
                    // Continue with signup flow even if check fails
                }
            }
            
            // Reset button state
            submitButton.disabled = false;
            submitButton.textContent = 'Sumali na';

            const formSection = document.getElementById('formSection');
            const mobileOtpSection = document.getElementById('mobileOtpSection');
            const otpVerificationSection = document.getElementById('otpVerificationSection');
            const successMessageOtp = document.getElementById('successMessageOtp');
            const errorMessageOtp = document.getElementById('errorMessageOtp');
            const sendOtpButton = document.getElementById('sendOtpButton');
            const verifyOtpButton = document.getElementById('verifyOtpButton');
            const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));

            // Hide form section
            if (formSection) {
                formSection.classList.remove('show');
                formSection.style.display = 'none';
            }

            // If email is entered, show mobile OTP section to ask for mobile number
            if (idIsEmail) {
                const emailValue = extraEmail || identifier;
                
                pendingSignupData = {
                    identifier,
                    email: normalizedEmail || emailValue,
                    password,
                    mobileE164: null,
                    mobileDisplay: null,
                    countryCode: selectedCountryCode,
                    countryIso: selectedCountryCode_iso,
                    staffInvite: staffInvite, // Include staff invite data
                    existingUser: existingUser // Include existing user data
                };

                initializeMobileOtp();

                // Hide OTP verification section if visible
                if (otpVerificationSection) {
                    otpVerificationSection.classList.remove('show');
                    otpVerificationSection.style.display = 'none';
                }

                // Show mobile OTP section
                if (mobileOtpSection) {
                    mobileOtpSection.classList.add('show');
                    mobileOtpSection.style.display = 'flex';
                }

                // Clear mobile OTP input
                const mobileOtpInputEl = document.getElementById('mobileOtpInput');
                if (mobileOtpInputEl) {
                    mobileOtpInputEl.value = '';
                    mobileOtpInputEl.dispatchEvent(new Event('input', { bubbles: true }));
                }

                stopOtpCountdown();

                if (successMessageOtp) {
                    successMessageOtp.classList.remove('show');
                    successMessageOtp.textContent = '';
                }
                if (errorMessageOtp) {
                    errorMessageOtp.classList.remove('show');
                    errorMessageOtp.textContent = '';
                }

                if (sendOtpButton) {
                    sendOtpButton.disabled = true;
                    sendOtpButton.textContent = 'Send OTP';
                }
                if (verifyOtpButton) {
                    verifyOtpButton.disabled = true;
                    verifyOtpButton.textContent = 'Verify';
                }
                otpInputs.forEach(input => {
                    if (input) input.value = '';
                });

                const mobileOtpInputFocus = document.getElementById('mobileOtpInput');
                if (mobileOtpInputFocus) {
                    mobileOtpInputFocus.focus();
                }

                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            // If mobile number is entered, validate and send OTP directly
            if (!validateMobile(identifier, selectedCountryCode_iso)) {
                if (selectedCountryCode_iso === 'PH') {
                    showError('Please enter a valid 10-digit Philippine mobile number');
                } else {
                    showError('Please enter a valid mobile number');
                }
                return;
            }

            let mobileDigits = identifier.replace(/\D/g, '');
            if (selectedCountryCode_iso === 'PH') {
                mobileDigits = mobileDigits.replace(/^0+/, '');
            }
            const finalFullMobileNumber = selectedCountryCode + mobileDigits;
            const displayMobile = formatLocalForDisplay(identifier, selectedCountryCode_iso);

            const emailValue = extraEmail || `phone_${finalFullMobileNumber.replace(/^\+/, '')}@verified.local`;

            pendingSignupData = {
                identifier,
                email: emailValue,
                password,
                mobileE164: finalFullMobileNumber,
                mobileDisplay: displayMobile,
                countryCode: selectedCountryCode,
                countryIso: selectedCountryCode_iso,
                staffInvite: staffInvite, // Include staff invite data
                existingUser: existingUser // Include existing user data
            };

            submitButton.disabled = true;
            submitButton.textContent = 'Sending OTP...';

            // Hide mobile OTP section
            if (mobileOtpSection) {
                mobileOtpSection.classList.remove('show');
                mobileOtpSection.style.display = 'none';
            }

            // Clear any previous error/success messages
            if (successMessageOtp) {
                successMessageOtp.classList.remove('show');
                successMessageOtp.textContent = '';
            }
            if (errorMessageOtp) {
                errorMessageOtp.classList.remove('show');
                errorMessageOtp.textContent = '';
            }

            // Send OTP and show verification section directly
            sendOtpAndShowVerification(finalFullMobileNumber, mobileDigits, selectedCountryCode, selectedCountryCode_iso);

            submitButton.disabled = false;
            submitButton.textContent = 'Sumali na';
        }

        // Handle back button
        function handleBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Handle sign in link
        function handleSignIn(event) {
            event.preventDefault();
            window.location.href = 'login.html';
        }

        // Show email/mobile form
        function showEmailMobileForm() {
            // Hide initial sections
            const logoSection = document.getElementById('logoSection');
            const socialAuthButtonsSection = document.getElementById('socialAuthButtonsSection');
            const dividerSection = document.getElementById('dividerSection');
            const emailMobileLinkSection = document.getElementById('emailMobileLinkSection');
            const mobileOtpSection = document.getElementById('mobileOtpSection');
            const formSection = document.getElementById('formSection');
            const socialAuthSection = document.getElementById('socialAuthSection');
            const successSection = document.getElementById('successSection');

            // Hide all initial content except logo
            if (socialAuthButtonsSection) socialAuthButtonsSection.style.display = 'none';
            if (dividerSection) dividerSection.style.display = 'none';
            if (emailMobileLinkSection) emailMobileLinkSection.style.display = 'none';
            if (mobileOtpSection) {
                mobileOtpSection.classList.remove('show');
                mobileOtpSection.style.display = 'none';
            }
            if (socialAuthSection) socialAuthSection.classList.remove('show');
            if (successSection) successSection.classList.remove('show');

            // Keep logo section visible
            if (logoSection) {
                logoSection.style.display = 'flex';
            }

            // Show form section
            if (formSection) {
                formSection.classList.add('show');
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showMainContent() {
            const logoSection = document.getElementById('logoSection');
            const socialAuthButtonsSection = document.getElementById('socialAuthButtonsSection');
            const dividerSection = document.getElementById('dividerSection');
            const emailMobileLinkSection = document.getElementById('emailMobileLinkSection');
            const mobileOtpSection = document.getElementById('mobileOtpSection');
            const formSection = document.getElementById('formSection');
            const socialAuthSection = document.getElementById('socialAuthSection');
            const successSection = document.getElementById('successSection');
            const sendOtpButton = document.getElementById('sendOtpButton');
            const verifyOtpButton = document.getElementById('verifyOtpButton');
            const mobileOtpInput = document.getElementById('mobileOtpInput');
            const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));

            if (logoSection) logoSection.style.display = 'flex';
            if (socialAuthButtonsSection) socialAuthButtonsSection.style.display = 'flex';
            if (dividerSection) dividerSection.style.display = 'flex';
            if (emailMobileLinkSection) emailMobileLinkSection.style.display = 'flex';

            if (mobileOtpSection) mobileOtpSection.classList.remove('show');
            if (formSection) {
                formSection.classList.remove('show');
                formSection.style.display = '';
            }
            if (socialAuthSection) socialAuthSection.classList.remove('show');
            if (successSection) successSection.classList.remove('show');

            hideError();
            hideSuccess();

            const otpError = document.getElementById('errorMessageOtp');
            const otpSuccess = document.getElementById('successMessageOtp');
            if (otpError) {
                otpError.classList.remove('show');
                otpError.textContent = '';
            }
            if (otpSuccess) {
                otpSuccess.classList.remove('show');
                otpSuccess.textContent = '';
            }

            if (sendOtpButton) {
                sendOtpButton.disabled = true;
                sendOtpButton.textContent = 'Send OTP';
            }
            if (verifyOtpButton) {
                verifyOtpButton.disabled = true;
                verifyOtpButton.textContent = 'Verify';
            }
            if (mobileOtpInput) {
                mobileOtpInput.value = '';
            }
            otpInputs.forEach(input => {
                if (input) input.value = '';
            });

            stopOtpCountdown();

            if (form) {
                form.reset();
                updateButtonState();
            }

            pendingSignupData = null;

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Sumali na';
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize mobile OTP functionality
        let mobileOtpInitialized = false;
        let otpInputsInitialized = false;
        function initializeMobileOtp() {
            const mobileOtpInput = document.getElementById('mobileOtpInput');
            const sendOtpButton = document.getElementById('sendOtpButton');
            const verifyOtpButton = document.getElementById('verifyOtpButton');
            const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));
            const countrySelectorOtp = document.getElementById('countrySelectorOtp');

            // Set up mobile input listeners only once
            if (!mobileOtpInitialized) {
                mobileOtpInitialized = true;

                // Mobile input validation
                if (mobileOtpInput && sendOtpButton) {
                    mobileOtpInput.addEventListener('input', () => {
                        const mobile = mobileOtpInput.value.trim();
                        const digits = mobile.replace(/\D/g, '');
                        const processedDigits = selectedCountryCode_iso === 'PH' ? digits.replace(/^0+/, '') : digits;
                        const isValid = selectedCountryCode_iso === 'PH' ? processedDigits.length === 10 : processedDigits.length >= 5;
                        sendOtpButton.disabled = !isValid;
                    });
                    // Add masking on blur/focus for OTP mobile input
                    mobileOtpInput.addEventListener('blur', () => {
                        mobileOtpInput.value = formatLocalForDisplay(mobileOtpInput.value, selectedCountryCode_iso);
                    });
                    mobileOtpInput.addEventListener('focus', () => {
                        mobileOtpInput.value = (mobileOtpInput.value || '').replace(/\D/g, '');
                    });
                }

                // Bind OTP country selector for accessibility and keyboard support
                if (countrySelectorOtp) {
                    countrySelectorOtp.setAttribute('role', 'button');
                    countrySelectorOtp.setAttribute('tabindex', '0');
                    countrySelectorOtp.setAttribute('aria-haspopup', 'listbox');
                    countrySelectorOtp.setAttribute('aria-expanded', 'false');
                    countrySelectorOtp.addEventListener('click', (e) => {
                        e.preventDefault();
                        toggleCountryPicker();
                    });
                    countrySelectorOtp.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleCountryPicker();
                        }
                    });
                }
            }

            // Update verify button state (make it accessible globally)
            window.updateVerifyButtonState = function() {
                const verifyBtn = document.getElementById('verifyOtpButton');
                const otpInputsCheck = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));
                if (!verifyBtn) return;
                const allFilled = otpInputsCheck.every(input => input && input.value && input.value.length === 1);
                verifyBtn.disabled = !allFilled;
            };

            // OTP input handling - auto-focus next
            // Use a data attribute to prevent duplicate listeners
            otpInputs.forEach((input, index) => {
                if (!input) return;
                
                // Check if listeners are already attached
                if (input.dataset.otpListenerAttached === 'true') {
                    return;
                }
                input.dataset.otpListenerAttached = 'true';

                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\D/g, '');
                    e.target.value = value.slice(0, 1);

                    // Move to next input if value entered
                    if (value && index < otpInputs.length - 1) {
                        const nextInput = document.getElementById(`otp${index + 2}`);
                        if (nextInput) nextInput.focus();
                    }

                    if (window.updateVerifyButtonState) {
                        window.updateVerifyButtonState();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    // Move to previous input on backspace if empty
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        const prevInput = document.getElementById(`otp${index}`);
                        if (prevInput) prevInput.focus();
                    }
                    // Update button state on backspace too
                    if (e.key === 'Backspace' && window.updateVerifyButtonState) {
                        setTimeout(() => window.updateVerifyButtonState(), 0);
                    }
                });

                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 4);
                    pastedData.split('').forEach((char, i) => {
                        const targetInput = document.getElementById(`otp${index + i + 1}`);
                        if (targetInput) {
                            targetInput.value = char;
                        }
                    });
                    if (window.updateVerifyButtonState) {
                        window.updateVerifyButtonState();
                    }
                    // Focus last input if all filled
                    if (pastedData.length === 4) {
                        const lastInput = document.getElementById('otp4');
                        if (lastInput) lastInput.focus();
                    }
                });
            });
            
            // Update button state after setting up listeners
            if (window.updateVerifyButtonState) {
                setTimeout(() => window.updateVerifyButtonState(), 0);
            }

            // Send OTP handler
            if (sendOtpButton) {
                sendOtpButton.addEventListener('click', handleSendOtp);
            }

            // Resend OTP handler
            const resendOtpButton = document.getElementById('resendOtpButton');
            if (resendOtpButton) {
                resendOtpButton.addEventListener('click', handleSendOtp);
            }

            // Verify OTP handler
            if (verifyOtpButton) {
                verifyOtpButton.addEventListener('click', handleVerifyOtp);
            }
        }

        // Show error message (for OTP section)
        function showErrorOtp(message) {
            // Check which section is visible
            const otpVerificationSection = document.getElementById('otpVerificationSection');
            const isVerificationVisible = otpVerificationSection && otpVerificationSection.classList.contains('show');
            
            if (isVerificationVisible) {
                // Show in OTP verification section
                const errorMessage = document.getElementById('errorMessageOtpVerify');
                const successMessage = document.getElementById('successMessageOtpVerify');
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.classList.add('show');
                }
                if (successMessage) {
                    successMessage.classList.remove('show');
                }
            } else {
                // Show in mobile OTP section
                const errorMessage = document.getElementById('errorMessageOtp');
                const successMessage = document.getElementById('successMessageOtp');
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.classList.add('show');
                }
                if (successMessage) {
                    successMessage.classList.remove('show');
                }
            }
        }

        // Show success message (for OTP section)
        function showSuccessOtp(message) {
            // Check which section is visible
            const otpVerificationSection = document.getElementById('otpVerificationSection');
            const isVerificationVisible = otpVerificationSection && otpVerificationSection.classList.contains('show');
            
            if (isVerificationVisible) {
                // Show in OTP verification section
                const successMessage = document.getElementById('successMessageOtpVerify');
                const errorMessage = document.getElementById('errorMessageOtpVerify');
                if (successMessage) {
                    successMessage.textContent = message;
                    successMessage.classList.add('show');
                }
                if (errorMessage) {
                    errorMessage.classList.remove('show');
                }
            } else {
                // Show in mobile OTP section
                const successMessage = document.getElementById('successMessageOtp');
                const errorMessage = document.getElementById('errorMessageOtp');
                if (successMessage) {
                    successMessage.textContent = message;
                    successMessage.classList.add('show');
                }
                if (errorMessage) {
                    errorMessage.classList.remove('show');
                }
            }
        }

        // OTP countdown timer
        let otpCountdownTimer = null;
        let otpCountdownSeconds = 0;

        function startOtpCountdown() {
            // Clear any existing timer
            if (otpCountdownTimer) {
                clearInterval(otpCountdownTimer);
            }

            const resendOtpButton = document.getElementById('resendOtpButton');
            if (!resendOtpButton) return;

            otpCountdownSeconds = 99;
            resendOtpButton.classList.add('disabled');
            updateOtpButtonText();

            otpCountdownTimer = setInterval(() => {
                otpCountdownSeconds--;
                if (otpCountdownSeconds <= 0) {
                    clearInterval(otpCountdownTimer);
                    otpCountdownTimer = null;
                    resendOtpButton.classList.remove('disabled');
                    resendOtpButton.textContent = 'Resend OTP';
                } else {
                    updateOtpButtonText();
                }
            }, 1000);
        }

        function updateOtpButtonText() {
            const resendOtpButton = document.getElementById('resendOtpButton');
            if (resendOtpButton && otpCountdownSeconds > 0) {
                resendOtpButton.textContent = `Resend in ${otpCountdownSeconds}s`;
            }
        }

        function stopOtpCountdown() {
            if (otpCountdownTimer) {
                clearInterval(otpCountdownTimer);
                otpCountdownTimer = null;
            }
            otpCountdownSeconds = 0;
            const resendOtpButton = document.getElementById('resendOtpButton');
            if (resendOtpButton) {
                resendOtpButton.classList.remove('disabled');
                resendOtpButton.textContent = 'Resend OTP';
            }
        }

        // Helper function to send OTP and transition to verification section
        async function sendOtpAndShowVerification(fullMobileNumber, mobileDigits, countryCode, countryIso) {
            // Store for resend
            currentVerifyingMobileNumber = fullMobileNumber;

            // Disable button during request
            const sendOtpButton = document.getElementById('sendOtpButton');
            const resendOtpButton = document.getElementById('resendOtpButton');
            
            if (sendOtpButton) {
                sendOtpButton.disabled = true;
                sendOtpButton.textContent = 'Validating...';
            }
            if (resendOtpButton) {
                resendOtpButton.classList.add('disabled');
                resendOtpButton.textContent = 'Validating...';
            }

            try {
                // First, validate mobile number ownership
                const validateResponse = await fetch(VALIDATE_MOBILE_NUMBER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                        'apikey': window.SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        mobile_number: fullMobileNumber
                    })
                });

                const validateData = await validateResponse.json();
                
                if (!validateResponse.ok) {
                    // Validation failed - show error message from backend
                    if (sendOtpButton) {
                        sendOtpButton.disabled = false;
                        sendOtpButton.textContent = 'Send OTP';
                    }
                    if (resendOtpButton) {
                        resendOtpButton.classList.remove('disabled');
                        resendOtpButton.textContent = 'Resend OTP';
                    }
                    showErrorOtp(validateData.error || 'Mobile number validation failed');
                    return;
                }

                // Validation passed - update button text and proceed to send OTP
                if (sendOtpButton) {
                    sendOtpButton.textContent = 'Sending...';
                }
                if (resendOtpButton) {
                    resendOtpButton.textContent = 'Sending...';
                }

                // Call Supabase Edge Function to send OTP
                const otpResponse = await fetch(SEND_VERIFICATION_CODE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                        'apikey': window.SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        mobile_number: fullMobileNumber
                    })
                });

                const otpData = await otpResponse.json();
                
                if (!otpResponse.ok) {
                    throw new Error(otpData.error || otpData.message || `Server error: ${otpResponse.status}`);
                }

                // OTP sent successfully
                // Format mobile number for display
                const displayMobile = formatLocalForDisplay(mobileDigits, countryIso);
                const formattedMobileNumber = `${countryCode} ${displayMobile}`;
                
                // Hide mobile OTP section and show OTP verification section
                const mobileOtpSection = document.getElementById('mobileOtpSection');
                const otpVerificationSection = document.getElementById('otpVerificationSection');
                
                if (mobileOtpSection) {
                    mobileOtpSection.classList.remove('show');
                    mobileOtpSection.style.display = 'none';
                }
                
                if (otpVerificationSection) {
                    otpVerificationSection.classList.add('show');
                    otpVerificationSection.style.display = 'flex';
                }
                
                // Update instruction text with mobile number
                const instructionText = document.getElementById('otpInstructionText');
                if (instructionText) {
                    instructionText.textContent = `Nag-send kami ng OTP sa ${formattedMobileNumber}. Ilagay lang sa taas para ma-verify ang number mo.`;
                }
                
                // Clear any previous error/success messages
                const errorMessageOtpVerify = document.getElementById('errorMessageOtpVerify');
                const successMessageOtpVerify = document.getElementById('successMessageOtpVerify');
                if (errorMessageOtpVerify) {
                    errorMessageOtpVerify.classList.remove('show');
                    errorMessageOtpVerify.textContent = '';
                }
                if (successMessageOtpVerify) {
                    successMessageOtpVerify.classList.remove('show');
                    successMessageOtpVerify.textContent = '';
                }
                
                // Reset OTP inputs
                const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));
                otpInputs.forEach(input => {
                    if (input) input.value = '';
                });
                
                // Ensure OTP input event listeners are set up
                initializeMobileOtp();
                
                // Start countdown timer
                startOtpCountdown();
                
                // Update verify button state (should be disabled initially)
                if (window.updateVerifyButtonState) {
                    window.updateVerifyButtonState();
                }
                
                // Focus first OTP input
                const otp1 = document.getElementById('otp1');
                if (otp1) {
                    setTimeout(() => otp1.focus(), 100);
                }
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Send OTP error:', error);
                if (sendOtpButton) {
                    sendOtpButton.disabled = false;
                    sendOtpButton.textContent = 'Send OTP';
                }
                if (resendOtpButton) {
                    resendOtpButton.classList.remove('disabled');
                    resendOtpButton.disabled = false;
                    resendOtpButton.textContent = 'Resend OTP';
                }
                showErrorOtp(error.message || 'Failed to send OTP. Please try again.');
            }
        }

        // Handle Send OTP
        async function handleSendOtp() {
            let mobile = '';
            let fullMobileNumber = '';
            
            // Get from input field first (prioritize new input over stored value)
            const mobileOtpInput = document.getElementById('mobileOtpInput');
            if (!mobileOtpInput) return;

            const inputValue = mobileOtpInput.value.trim();
            
            // If input field has a value, use it (new input)
            // Otherwise, use stored mobile number (resend scenario)
            if (inputValue) {
                mobile = inputValue;
                const digits = mobile.replace(/\D/g, '');
                const processedDigits = selectedCountryCode_iso === 'PH' ? digits.replace(/^0+/, '') : digits;

                if ((selectedCountryCode_iso === 'PH' && processedDigits.length !== 10) ||
                    (selectedCountryCode_iso !== 'PH' && processedDigits.length < 5)) {
                    showErrorOtp(selectedCountryCode_iso === 'PH' ? 'Please enter a valid 10-digit Philippine mobile number' : 'Please enter a valid mobile number');
                    return;
                }

                fullMobileNumber = selectedCountryCode + processedDigits;
            } else if (currentVerifyingMobileNumber) {
                // No input value, use stored mobile number (resend)
                fullMobileNumber = currentVerifyingMobileNumber;
                // Extract mobile digits for validation
                const storedDigits = currentVerifyingMobileNumber.replace(/^\+/, '').replace(/\D/g, '');
                mobile = storedDigits;
            } else {
                // No input and no stored value
                showErrorOtp(selectedCountryCode_iso === 'PH' ? 'Please enter a valid 10-digit Philippine mobile number' : 'Please enter a valid mobile number');
                return;
            }

            const normalizedMobile = normalizePhone(fullMobileNumber);
            const displayMobile = formatLocalForDisplay(mobile, selectedCountryCode_iso);
            
            // Determine country code and mobile digits for display
            const countryCodeMatch = fullMobileNumber.match(/^(\+\d+)(.+)$/);
            const countryCode = countryCodeMatch ? countryCodeMatch[1] : selectedCountryCode;
            const mobileDigits = countryCodeMatch ? countryCodeMatch[2].replace(/\D/g, '') : mobile.replace(/\D/g, '');
            
            // Check for staff invite by mobile using edge function
            if (pendingSignupData && !pendingSignupData.staffInvite) {
                try {
                    const checkResponse = await fetch(CHECK_STAFF_INVITE_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                            'apikey': window.SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            mobile_no: normalizedMobile || fullMobileNumber
                        })
                    });

                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        if (checkData.has_staff_invite) {
                            pendingSignupData.staffInvite = checkData.staff_invite;
                            console.log('Staff invite found by mobile:', checkData.staff_invite);
                        }
                        if (checkData.has_existing_user) {
                            pendingSignupData.existingUser = checkData.existing_user;
                            console.log('Existing user found by mobile:', checkData.existing_user);
                        }
                    } else {
                        const errorData = await checkResponse.json().catch(() => ({}));
                        console.warn('Check staff invite by mobile returned error:', errorData);
                    }
                } catch (checkError) {
                    console.error('Error checking staff invite by mobile:', checkError);
                    // Continue with OTP flow even if check fails
                }
            }
            
            // Update pendingSignupData with mobile number
            if (pendingSignupData) {
                pendingSignupData.mobileE164 = fullMobileNumber;
                pendingSignupData.mobileDisplay = displayMobile;
                pendingSignupData.countryCode = selectedCountryCode;
                pendingSignupData.countryIso = selectedCountryCode_iso;
            }
            
            sendOtpAndShowVerification(fullMobileNumber, mobileDigits, countryCode, selectedCountryCode_iso);
        }

        // Handle Verify OTP
        function handleVerifyOtp() {
            const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));
            const otp = otpInputs.map(input => input ? input.value : '').join('');

            if (otp.length !== 4) {
                showErrorOtp('Please enter the complete OTP');
                return;
            }

            // Get mobile number from stored value (used when OTP verification section is visible)
            let fullMobileNumber = null;
            
            if (currentVerifyingMobileNumber) {
                // Use stored mobile number from OTP send
                fullMobileNumber = currentVerifyingMobileNumber;
            } else {
                // Fallback: Get from input field (for backward compatibility)
                const mobileOtpInput = document.getElementById('mobileOtpInput');
                if (!mobileOtpInput) {
                    showErrorOtp('Mobile number not found');
                    return;
                }

                const mobile = mobileOtpInput.value.trim();
                const digits = mobile.replace(/\D/g, '');
                const processedDigits = selectedCountryCode_iso === 'PH' ? digits.replace(/^0+/, '') : digits;
                fullMobileNumber = selectedCountryCode + processedDigits;
                
                if (pendingSignupData) {
                    pendingSignupData.mobileE164 = fullMobileNumber;
                    pendingSignupData.mobileDisplay = formatLocalForDisplay(mobile, selectedCountryCode_iso);
                }
            }

            const verifyOtpButton = document.getElementById('verifyOtpButton');
            if (verifyOtpButton) {
                verifyOtpButton.disabled = true;
                verifyOtpButton.textContent = 'Verifying...';
            }

            // Call Supabase Edge Function to verify OTP
            fetch(VERIFY_CODE_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                    'apikey': window.SUPABASE_ANON_KEY
                },
                body: JSON.stringify({
                    mobile_number: fullMobileNumber,
                    code: otp
                })
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || data.message || `Server error: ${response.status}`);
                    }
                    return data;
                })
                .then(async (verifyResponse) => {
                    // Check if this is an OAuth user (has active session)
                    let session = null;
                    if (supabaseClient) {
                        const { data: sessionData } = await supabaseClient.auth.getSession();
                        session = sessionData?.session;
                    }

                    if (session) {
                        // OAuth user: Link mobile number to existing account
                        console.log('OAuth user - linking mobile number to account');
                        
                        // Get user info from OAuth session
                        const user = session.user;
                        const userMetadata = user.user_metadata || {};
                        const appMetadata = user.app_metadata || {};
                        
                        // Extract name from OAuth provider metadata
                        // Different providers use different field names:
                        // Google: given_name, family_name, name
                        // Apple: firstName, lastName, fullName
                        // Facebook: first_name, last_name, name
                        const fullName = userMetadata.full_name || 
                                         userMetadata.name || 
                                         `${userMetadata.first_name || userMetadata.given_name || userMetadata.firstName || ''} ${userMetadata.last_name || userMetadata.family_name || userMetadata.lastName || ''}`.trim() ||
                                         user.email?.split('@')[0] || 
                                         'User';
                        
                        const firstName = userMetadata.first_name || 
                                         userMetadata.given_name || 
                                         userMetadata.firstName ||
                                         fullName.split(' ')[0] || 
                                         'User';
                        const lastName = userMetadata.last_name || 
                                        userMetadata.family_name || 
                                        userMetadata.lastName || 
                                        fullName.split(' ').slice(1).join(' ') || 
                                        '';
                        
                        // Truncate fields to fit database constraints (VARCHAR(20) for nickname)
                        const truncatedFirstName = firstName.length > 20 ? firstName.substring(0, 20) : firstName;
                        
                        // IMPORTANT: Update auth user's phone and metadata BEFORE calling signup-user
                        // This ensures the mobile number is saved in the database so the trigger
                        // can find staff_invite by mobile number
                        console.log('Updating auth user with verified mobile number:', fullMobileNumber);
                        try {
                            const { data: updateData, error: updateError } = await supabaseClient.auth.updateUser({
                                phone: fullMobileNumber,
                                data: {
                                    ...userMetadata,
                                    mobile_no: fullMobileNumber,
                                    phone: fullMobileNumber,
                                    full_name: fullName,
                                    first_name: firstName,
                                    last_name: lastName
                                }
                            });
                            
                            if (updateError) {
                                console.warn('Failed to update auth user metadata:', updateError);
                                // Continue anyway - signup-user will handle it
                            } else {
                                console.log('Successfully updated auth user with mobile number');
                                // Refresh session to get updated user data
                                const { data: { session: refreshedSession } } = await supabaseClient.auth.refreshSession();
                                if (refreshedSession) {
                                    session = refreshedSession;
                                }
                            }
                        } catch (updateErr) {
                            console.warn('Error updating auth user metadata:', updateErr);
                            // Continue anyway - signup-user will handle it
                        }
                        
                        // For OAuth users, we send all required fields
                        // The backend should recognize this is an OAuth user via the access_token
                        // and handle the password field appropriately (ignore it or use a placeholder)
                        // Use refreshed session token if available (session was updated above)
                        const linkMobileResponse = await fetch(SIGNUP_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`,
                                'apikey': window.SUPABASE_ANON_KEY,
                            },
                            body: JSON.stringify({
                                mobile_no: fullMobileNumber,
                                full_name: fullName,
                                first_name: truncatedFirstName,
                                last_name: null,
                                nickname: truncatedFirstName,
                                // OAuth users don't have passwords - backend should handle this
                                // Sending placeholder that backend can ignore for OAuth users
                                password: 'oauth_authenticated_user_no_password_required'
                            }),
                        });

                        // Handle response - 409 means user already exists
                        // Backend should check staff_invite table and link household if found
                        if (!linkMobileResponse.ok && linkMobileResponse.status !== 409) {
                            const result = await linkMobileResponse.json().catch(() => ({}));
                            const errorMsg = result.error || result.message || 'Failed to link mobile number';
                            
                            // Log error for debugging
                            console.warn('Link mobile endpoint returned error:', errorMsg);
                            
                            // Only throw if it's a critical error (not user already exists)
                            if (linkMobileResponse.status !== 400 && linkMobileResponse.status !== 409) {
                                throw new Error(errorMsg);
                            }
                        }

                        // Check if we got a successful response or 409 (user exists but might be linking invite)
                        if (linkMobileResponse.ok || linkMobileResponse.status === 409) {
                            console.log('Mobile number linked successfully (or user already exists with staff invite)');
                        }
                        return { success: true };
                    } else if (pendingSignupData) {
                        // Manual signup path: Create new user account
                        // Step 5: Combine the data (existing user data + new signup data)
                        const existingUserData = pendingSignupData.existingUser;
                        
                        // Use existing user data if available, otherwise use defaults
                        const firstName = existingUserData?.first_name || 'Kas';
                        const signupPayload = {
                            email: pendingSignupData.email,
                            password: pendingSignupData.password,
                            mobile_no: pendingSignupData.mobileE164,
                            full_name: existingUserData?.full_name || 'Kas User',
                            first_name: firstName,
                            last_name: null,
                            nickname: firstName
                        };
                        
                        // Include staff invite info if found (backend can use this)
                        if (pendingSignupData.staffInvite) {
                            console.log('Sending signup with staff invite data:', pendingSignupData.staffInvite);
                            // Backend will check staff_invite table, but we can include it for reference
                            signupPayload.staff_invite_id = pendingSignupData.staffInvite.id;
                        }

                        const signupResponse = await fetch(SIGNUP_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                                'apikey': window.SUPABASE_ANON_KEY
                            },
                            body: JSON.stringify(signupPayload)
                        });

                        const data = await signupResponse.json();
                        if (!signupResponse.ok) {
                            // Handle "user already exists" errors more gracefully
                            // This might happen if user exists but has staff invite (backend should handle)
                            if (signupResponse.status === 400 || signupResponse.status === 409) {
                                const errorMsg = data.error || data.message || '';
                                
                                // If user already exists, suggest login instead
                                // Backend should handle staff invites automatically, but if it fails
                                // we provide helpful error message
                                if (errorMsg.toLowerCase().includes('already been registered') || 
                                    errorMsg.toLowerCase().includes('already exists')) {
                                    throw new Error('Ang email o mobile number mo ay nakaregister na. Kung may staff invite ka, subukan mong mag-login sa halip.');
                                }
                            }
                            throw new Error(data.error || data.message || `Signup failed: ${signupResponse.status}`);
                        }

                        console.log('Signup inputs captured:', {
                            ...pendingSignupData,
                            otp
                        });
                        pendingSignupData = null;
                        return data;
                    } else {
                        throw new Error('Signup data missing after OTP verification.');
                    }
                })
                .then(() => {
                    // Only reset button and show success for email/password flow
                    // Provider flow will redirect before reaching here
                    if (verifyOtpButton) {
                        verifyOtpButton.disabled = false;
                        verifyOtpButton.textContent = 'Verify';
                    }
                    showSuccessScreen();
                })
                .catch(error => {
                    console.error('Verify OTP error:', error);
                    if (verifyOtpButton) {
                        verifyOtpButton.disabled = false;
                        verifyOtpButton.textContent = 'Verify';
                    }
                    showErrorOtp(error.message || 'Failed to verify OTP. Please try again.');
                });
        }

        // Provider OAuth (web) using Supabase
        let supabaseClient = null;
        function initSupabase() {
            if (window.supabase && SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, window.SUPABASE_ANON_KEY);
            }
        }

        // Store original button texts
        const originalButtonTexts = new Map();

        function setProviderButtonsDisabled(disabled, text, specificButtonId = null) {
            const buttons = [
                document.getElementById('googleAuthButton'),
                document.getElementById('facebookAuthButton'),
                document.getElementById('appleAuthButton')
            ].filter(Boolean);
            
            buttons.forEach(btn => {
                // Store original text if not already stored
                if (!originalButtonTexts.has(btn.id)) {
                    const span = btn.querySelector('span');
                    if (span) {
                        originalButtonTexts.set(btn.id, span.textContent);
                    }
                }
                
                btn.disabled = disabled;
                
                const span = btn.querySelector('span');
                if (span) {
                    if (text && (!specificButtonId || btn.id === specificButtonId)) {
                        // Only update text for the specific button if specified, or all if not
                        span.textContent = text;
                    } else if (!disabled && !text) {
                        // Restore original text when re-enabling
                        const originalText = originalButtonTexts.get(btn.id);
                        if (originalText) {
                            span.textContent = originalText;
                        }
                    }
                }
            });
        }

        // Begin provider signup - direct OAuth (no OTP)
        function beginProviderSignupWithOtp(provider) {
            hideError();
            hideSuccess();
            if (!supabaseClient) initSupabase();
            if (!supabaseClient) {
                showError('Unable to initialize authentication. Please try again later.');
                return;
            }

            // Capitalize provider name for display
            const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
            const buttonId = `${provider}AuthButton`;
            
            // Disable all buttons, but only update text on the clicked button
            setProviderButtonsDisabled(true, `Opening ${providerName}...`, buttonId);

            // Build web redirect URL - ensure it's HTTPS and properly formatted
            let redirectTo = window.location.origin + window.location.pathname;

            // Remove trailing slash if present
            redirectTo = redirectTo.replace(/\/$/, '');

            // Ensure HTTPS (required for OAuth redirects)
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                console.warn('OAuth requires HTTPS. Current protocol:', window.location.protocol);
            }

            // Log for debugging
            console.log('OAuth redirect URL:', redirectTo);

            supabaseClient.auth.signInWithOAuth({
                provider: provider,
                options: {
                    redirectTo: redirectTo,
                    queryParams: {
                        // Explicitly indicate this is a web flow
                        access_type: 'offline',
                        prompt: 'consent'
                    }
                }
            }).then(({ error, data }) => {
                if (error) {
                    console.error('OAuth error:', error);
                    setProviderButtonsDisabled(false);
                    showError(error.message || 'Could not open provider sign in. Please try again.');
                } else if (data?.url) {
                    // If Supabase returns a URL, redirect manually to ensure web flow
                    console.log('Redirecting to OAuth provider:', data.url);
                    window.location.href = data.url;
                }
                // Otherwise, Supabase will handle redirect automatically
            }).catch((error) => {
                console.error('OAuth catch error:', error);
                setProviderButtonsDisabled(false);
                showError(error.message || 'Could not open provider sign in. Please try again.');
            });
        }

        // Expose globally for inline onclick
        window.beginProviderSignupWithOtp = beginProviderSignupWithOtp;

        async function handleProviderSignup(provider) {
            try {
                hideError();
                setProviderButtonsDisabled(true, 'Continuing...');
                if (!supabaseClient) initSupabase();
                if (!supabaseClient) {
                    throw new Error('Unable to initialize authentication. Please try again later.');
                }
                // Build complete redirect URL with domain (required by Supabase)
                let redirectTo = window.location.origin + window.location.pathname;
                // Remove trailing slash if present
                redirectTo = redirectTo.replace(/\/$/, '');

                console.log('OAuth redirect URL:', redirectTo);

                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider,
                    options: {
                        redirectTo,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                });
                if (error) throw error;
                // Will redirect; no further code runs here
            } catch (e) {
                console.error('OAuth start error:', e);
                setProviderButtonsDisabled(false);
                showError(e.message || 'Failed to start provider sign-up. Please try again.');
            }
        }

        // Show mobile OTP screen after OAuth signup
        function showMobileOtpScreenAfterOAuth() {
            console.log('showMobileOtpScreenAfterOAuth called');
            // Ensure supabaseClient is initialized for OTP verification
            if (!supabaseClient) initSupabase();
            
            // Hide all sections
            const logoSection = document.getElementById('logoSection');
            const socialAuthButtonsSection = document.getElementById('socialAuthButtonsSection');
            const dividerSection = document.getElementById('dividerSection');
            const emailMobileLinkSection = document.getElementById('emailMobileLinkSection');
            const formSection = document.getElementById('formSection');
            const socialAuthSection = document.getElementById('socialAuthSection');
            const successSection = document.getElementById('successSection');
            const mobileOtpSection = document.getElementById('mobileOtpSection');
            const otpVerificationSection = document.getElementById('otpVerificationSection');

            // Hide all content
            console.log('Hiding sections, showing mobile OTP section');
            if (logoSection) {
                logoSection.style.display = 'none';
                console.log('Logo section hidden');
            }
            if (socialAuthButtonsSection) {
                socialAuthButtonsSection.style.display = 'none';
                console.log('Social auth buttons section hidden');
            }
            if (dividerSection) dividerSection.style.display = 'none';
            if (emailMobileLinkSection) emailMobileLinkSection.style.display = 'none';
            if (formSection) {
                formSection.classList.remove('show');
                formSection.style.display = 'none';
            }
            if (socialAuthSection) socialAuthSection.classList.remove('show');
            if (successSection) successSection.classList.remove('show');
            if (otpVerificationSection) {
                otpVerificationSection.classList.remove('show');
                otpVerificationSection.style.display = 'none';
            }

            // Initialize mobile OTP if not already initialized
            initializeMobileOtp();

            // Show mobile OTP section
            if (mobileOtpSection) {
                mobileOtpSection.classList.add('show');
                mobileOtpSection.style.display = 'flex';
                console.log('Mobile OTP section shown');
            } else {
                console.error('Mobile OTP section element not found!');
            }

            // Reset OTP section state
            const successMessageOtp = document.getElementById('successMessageOtp');
            const errorMessageOtp = document.getElementById('errorMessageOtp');
            const sendOtpButton = document.getElementById('sendOtpButton');
            const verifyOtpButton = document.getElementById('verifyOtpButton');
            const mobileOtpInput = document.getElementById('mobileOtpInput');
            const otpInputs = ['otp1', 'otp2', 'otp3', 'otp4'].map(id => document.getElementById(id));

            stopOtpCountdown();

            if (successMessageOtp) {
                successMessageOtp.classList.remove('show');
                successMessageOtp.textContent = '';
            }
            if (errorMessageOtp) {
                errorMessageOtp.classList.remove('show');
                errorMessageOtp.textContent = '';
            }

            if (sendOtpButton) {
                sendOtpButton.disabled = true; // Disabled until valid mobile number is entered
                sendOtpButton.textContent = 'Send OTP';
            }
            if (verifyOtpButton) {
                verifyOtpButton.disabled = true;
                verifyOtpButton.textContent = 'Verify';
            }
            
            // Reset resend button
            const resendOtpButton = document.getElementById('resendOtpButton');
            if (resendOtpButton) {
                resendOtpButton.classList.add('disabled');
                resendOtpButton.textContent = 'Resend in 0s';
            }
            
            if (mobileOtpInput) {
                mobileOtpInput.value = '';
            }
            otpInputs.forEach(input => {
                if (input) input.value = '';
            });

            // Focus mobile input
            if (mobileOtpInput) {
                setTimeout(() => mobileOtpInput.focus(), 100);
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show success screen after OTP verification (same pattern as showSocialAuthInstructions)
        function showSuccessScreen() {
            // Hide all sections
            const logoSection = document.getElementById('logoSection');
            const socialAuthButtonsSection = document.getElementById('socialAuthButtonsSection');
            const dividerSection = document.getElementById('dividerSection');
            const emailMobileLinkSection = document.getElementById('emailMobileLinkSection');
            const mobileOtpSection = document.getElementById('mobileOtpSection');
            const otpVerificationSection = document.getElementById('otpVerificationSection');
            const socialAuthSection = document.getElementById('socialAuthSection');
            const successSection = document.getElementById('successSection');

            // Hide all content
            if (logoSection) logoSection.style.display = 'none';
            if (socialAuthButtonsSection) socialAuthButtonsSection.style.display = 'none';
            if (dividerSection) dividerSection.style.display = 'none';
            if (emailMobileLinkSection) emailMobileLinkSection.style.display = 'none';
            if (mobileOtpSection) {
                mobileOtpSection.classList.remove('show');
                mobileOtpSection.style.display = 'none';
            }
            if (otpVerificationSection) {
                otpVerificationSection.classList.remove('show');
                otpVerificationSection.style.display = 'none';
            }
            if (socialAuthSection) socialAuthSection.classList.remove('show');

            // Stop countdown timer when hiding OTP section
            stopOtpCountdown();
            
            // Clear stored mobile number
            currentVerifyingMobileNumber = null;

            // Show success section
            if (successSection) {
                successSection.classList.add('show');
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // Attempt to focus the success title for accessibility
                const titleEl = successSection.querySelector('.success-title');
                if (titleEl) {
                    titleEl.setAttribute('tabindex', '-1');
                    try { titleEl.focus(); } catch (e) { }
                }
            }
        }

        // Device detection function (same as getdomo.html)
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();

            // Check for Android
            if (userAgent.includes('android')) {
                return 'android';
            }

            // Check for iOS (iPhone, iPad, iPod)
            if (/iphone|ipad|ipod/.test(userAgent)) {
                return 'ios';
            }

            // Check for other mobile devices
            if (/mobile|tablet/.test(userAgent)) {
                return 'mobile';
            }

            return 'desktop';
        }

        // Redirect to appropriate app store based on device
        function redirectToStore() {
            const device = detectDevice();
            if (device === 'ios') {
                window.location.replace('https://apps.apple.com/app/domo');
            } else if (device === 'android') {
                window.location.replace('https://play.google.com/store/apps/details?id=com.domohousehold');
            } else {
                // Desktop fallback - redirect to main landing page
                window.location.replace('index.html');
            }
        }

        // Apply device detection to app store buttons
        function applyDeviceDetection() {
            const device = detectDevice();
            const body = document.body;

            // Remove existing device classes
            body.classList.remove('device-android', 'device-ios', 'device-mobile', 'device-desktop');

            // Add device-specific class
            body.classList.add(`device-${device}`);
        }

        // Initialize device detection on page load
        window.addEventListener('DOMContentLoaded', () => {
            applyDeviceDetection();
        });

        // Parse OAuth tokens from URL hash, query params, or current URL
        function parseOAuthTokens() {
            // Check URL hash first (standard OAuth redirect)
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');

                if (accessToken && refreshToken) {
                    console.log('Found tokens in URL hash');
                    return {
                        access_token: accessToken,
                        refresh_token: refreshToken,
                        expires_at: params.get('expires_at') ? parseInt(params.get('expires_at')) : null,
                        token_type: params.get('token_type') || 'bearer'
                    };
                }
            }

            // Check query parameters (some OAuth flows use query params)
            const searchParams = new URLSearchParams(window.location.search);
            const queryAccessToken = searchParams.get('access_token');
            const queryRefreshToken = searchParams.get('refresh_token');

            if (queryAccessToken && queryRefreshToken) {
                console.log('Found tokens in query parameters');
                return {
                    access_token: queryAccessToken,
                    refresh_token: queryRefreshToken,
                    expires_at: searchParams.get('expires_at') ? parseInt(searchParams.get('expires_at')) : null,
                    token_type: searchParams.get('token_type') || 'bearer'
                };
            }

            // Check if current URL contains OAuth tokens (fallback for failed deeplink redirects)
            const fullUrl = window.location.href;
            const tokenMatch = fullUrl.match(/access_token=([^&]+)/);
            const refreshMatch = fullUrl.match(/refresh_token=([^&]+)/);

            if (tokenMatch && refreshMatch) {
                console.log('Found tokens in URL string');
                return {
                    access_token: decodeURIComponent(tokenMatch[1]),
                    refresh_token: decodeURIComponent(refreshMatch[1]),
                    expires_at: null,
                    token_type: 'bearer'
                };
            }

            return null;
        }

        // Process OAuth callback: set session, call signup-user, then show success
        async function processOAuthCallback() {
            // Synchronous checks to prevent duplicate processing
            const alreadyProcessed = sessionStorage.getItem('oauthProcessed');
            if (alreadyProcessed) {
                console.log('OAuth callback already processed, checking if should show mobile OTP screen...');
                try {
                    initSupabase();
                    if (supabaseClient) {
                        const { data: sessionData } = await supabaseClient.auth.getSession();
                        if (sessionData?.session) {
                            console.log('Found active session, showing mobile OTP screen...');
                            showMobileOtpScreenAfterOAuth();
                        }
                    }
                } catch (e) {
                    console.error('Error checking session after OAuth:', e);
                }
                return;
            }

            // Check processing flag to prevent concurrent execution
            if (isProcessingOAuth) {
                console.log('OAuth callback already being processed, skipping duplicate call...');
                return;
            }

            // Set flag immediately to prevent concurrent calls
            isProcessingOAuth = true;

            try {
                initSupabase();
                if (!supabaseClient) {
                    console.error('Supabase client not initialized');
                    return;
                }

                console.log('Processing OAuth callback...');
                console.log('Current URL:', window.location.href);
                console.log('URL hash:', window.location.hash);
                console.log('URL search:', window.location.search);

                // Check for OAuth tokens in URL (hash, query params, or full URL)
                const tokens = parseOAuthTokens();
                let session = null;

                if (tokens) {
                    console.log('Found OAuth tokens, setting session...');
                    try {
                        // Set the session using tokens from URL
                        const { data: sessionData, error: sessionError } = await supabaseClient.auth.setSession({
                            access_token: tokens.access_token,
                            refresh_token: tokens.refresh_token
                        });

                        if (sessionError) {
                            console.error('Error setting session:', sessionError);
                            showError('Failed to complete sign in. Please try again.');
                            return;
                        }

                        session = sessionData?.session;
                        console.log('Session set successfully:', session ? 'Yes' : 'No');

                        // Clean up URL - remove tokens from hash and query params
                        let cleanUrl = window.location.pathname;
                        const searchParams = new URLSearchParams(window.location.search);
                        searchParams.delete('access_token');
                        searchParams.delete('refresh_token');
                        searchParams.delete('expires_at');
                        searchParams.delete('token_type');
                        const cleanSearch = searchParams.toString();
                        if (cleanSearch) {
                            cleanUrl += '?' + cleanSearch;
                        }
                        // Remove hash fragment (tokens are usually in hash)
                        window.history.replaceState(null, '', cleanUrl);
                    } catch (hashError) {
                        console.error('Error processing OAuth tokens:', hashError);
                        showError('Failed to process sign in. Please try again.');
                        return;
                    }
                } else {
                    // Try to get existing session (Supabase may have already handled it)
                    console.log('No tokens found, checking for existing session...');
                    const { data, error } = await supabaseClient.auth.getSession();
                    if (error) {
                        console.warn('Session fetch error:', error);
                        // Don't return here - might be a new user flow
                    } else {
                        session = data?.session;
                        console.log('Existing session found:', session ? 'Yes' : 'No');
                    }
                }

                // If we have a session and haven't processed it yet, finalize signup
                if (session) {
                    // Mark as processed immediately to prevent duplicate processing
                    sessionStorage.setItem('oauthProcessed', '1');
                    console.log('Processing provider signup for user:', session.user?.id);

                    // Call signup-user edge function to create user profile
                    try {
                        // Extract user info from OAuth session
                        const user = session.user;
                        const userMetadata = user.user_metadata || {};
                        
                        // Normalize email for staff invite check
                        const normalizedEmail = user.email ? user.email.trim().toLowerCase() : null;
                        
                        // Check for staff invite before calling signup-user
                        let staffInvite = null;
                        let existingUser = null;
                        
                        if (normalizedEmail) {
                            try {
                                console.log('Checking for staff invite with email:', normalizedEmail);
                                const checkResponse = await fetch(CHECK_STAFF_INVITE_ENDPOINT, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'Bearer ' + window.SUPABASE_ANON_KEY,
                                        'apikey': window.SUPABASE_ANON_KEY
                                    },
                                    body: JSON.stringify({
                                        email: normalizedEmail,
                                        mobile_no: null // Mobile number not available yet in OAuth flow
                                    })
                                });

                                if (checkResponse.ok) {
                                    const checkData = await checkResponse.json();
                                    if (checkData.has_staff_invite) {
                                        staffInvite = checkData.staff_invite;
                                        console.log('Staff invite found for OAuth user:', staffInvite);
                                    }
                                    if (checkData.has_existing_user) {
                                        existingUser = checkData.existing_user;
                                        console.log('Existing user found for OAuth user:', existingUser);
                                    }
                                } else {
                                    const errorData = await checkResponse.json().catch(() => ({}));
                                    console.warn('Check staff invite returned error:', errorData);
                                }
                            } catch (checkError) {
                                console.error('Error checking staff invite for OAuth user:', checkError);
                                // Continue with signup flow even if check fails
                            }
                        }
                        
                        // Get role from URL params if available, default to 'kasambahay'
                        const urlParams = new URLSearchParams(window.location.search);
                        const role = urlParams.get('role') || 'kasambahay';
                        
                        // Extract name from OAuth provider metadata
                        // Different providers use different field names:
                        // Google: given_name, family_name, name
                        // Apple: firstName, lastName, fullName
                        // Facebook: first_name, last_name, name
                        const fullName = userMetadata.full_name || 
                                         userMetadata.name || 
                                         `${userMetadata.first_name || userMetadata.given_name || userMetadata.firstName || ''} ${userMetadata.last_name || userMetadata.family_name || userMetadata.lastName || ''}`.trim() ||
                                         user.email?.split('@')[0] || 
                                         'User';
                        
                        const firstName = userMetadata.first_name || 
                                         userMetadata.given_name || 
                                         userMetadata.firstName ||
                                         fullName.split(' ')[0] || 
                                         'User';
                        
                        const lastName = userMetadata.last_name || 
                                        userMetadata.family_name || 
                                        userMetadata.lastName || 
                                        fullName.split(' ').slice(1).join(' ') || 
                                        '';

                        console.log('Calling signup-user with OAuth user data:', { role, fullName, firstName, lastName, hasStaffInvite: !!staffInvite });

                        // Build signup payload with staff invite info if found
                        const signupPayload = {
                            role,
                            full_name: fullName,
                            first_name: firstName,
                            last_name: lastName,
                            email: user.email || null,
                            // OAuth users don't have passwords - backend should handle this
                            password: 'oauth_authenticated_user_no_password_required',
                            // mobile_no will be added later when user verifies OTP
                            mobile_no: null
                        };
                        
                        // Include staff invite info if found (backend can use this)
                        if (staffInvite) {
                            console.log('Including staff invite data in signup payload:', staffInvite);
                            signupPayload.staff_invite_id = staffInvite.id;
                        }

                        const response = await fetch(SIGNUP_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`,
                                'apikey': window.SUPABASE_ANON_KEY,
                            },
                            body: JSON.stringify(signupPayload),
                        });

                        // Handle response - 409 means user already exists, which is fine
                        // Backend will automatically check staff_invite table and handle appropriately
                        if (!response.ok && response.status !== 409) {
                            const result = await response.json().catch(() => ({}));
                            const errorMsg = result.error || result.message || 'Failed to finalize signup';
                            
                            // Log error for debugging but continue with mobile OTP flow
                            // Backend should handle staff invites, but if it fails we continue anyway
                            console.warn('Signup endpoint returned error:', errorMsg);
                            
                            // Only throw if it's a critical error (not user already exists)
                            if (response.status !== 400 && response.status !== 409) {
                                throw new Error(errorMsg);
                            }
                        }

                        console.log('Provider signup finalized successfully');
                    } catch (finalizeError) {
                        console.error('Finalize provider signup error:', finalizeError);
                        // Still show mobile OTP screen even if finalize fails
                    }

                    // Show mobile OTP screen to collect mobile number
                    console.log('Showing mobile OTP screen...');
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        showMobileOtpScreenAfterOAuth();
                    }, 100);
                } else if (!session) {
                    console.log('No session found - user may not have completed OAuth flow');
                    // Don't show error - user might just be visiting the page normally
                }
            } catch (e) {
                console.error('OAuth callback processing error:', e);
                showError('An error occurred. Please try again.');
                // Clear processing flag on error so user can retry
                isProcessingOAuth = false;
            } finally {
                setProviderButtonsDisabled(false);
                // Clear processing flag after completion
                isProcessingOAuth = false;
            }
        }

        // Set up auth state change listener as backup
        function setupAuthStateListener() {
            if (!supabaseClient) {
                initSupabase();
            }
            if (supabaseClient) {
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event, session ? 'Session exists' : 'No session');
                    if (event === 'SIGNED_IN' && session) {
                        const alreadyProcessed = sessionStorage.getItem('oauthProcessed');
                        if (!alreadyProcessed) {
                            console.log('User signed in via auth state change, processing...');
                            // Small delay to ensure everything is ready
                            setTimeout(() => {
                                processOAuthCallback();
                            }, 100);
                        } else {
                            console.log('OAuth already processed, showing mobile OTP screen...');
                            showMobileOtpScreenAfterOAuth();
                        }
                    }
                });
            }
        }

        // Check for existing session on page load and show mobile OTP if needed
        async function checkExistingSessionAndShowMobileOtp() {
            try {
                initSupabase();
                if (supabaseClient) {
                    const { data: sessionData } = await supabaseClient.auth.getSession();
                    if (sessionData?.session && sessionStorage.getItem('oauthProcessed')) {
                        console.log('Found existing session after OAuth, showing mobile OTP screen...');
                        showMobileOtpScreenAfterOAuth();
                    }
                }
            } catch (e) {
                console.error('Error checking existing session:', e);
            }
        }

        // OAuth return handling on page load - consolidated to prevent duplicate calls
        function initializeOAuthHandling() {
            setupAuthStateListener();
            processOAuthCallback();
            checkExistingSessionAndShowMobileOtp();
        }

        if (document.readyState === 'loading') {
            // DOM still loading, wait for DOMContentLoaded
            window.addEventListener('DOMContentLoaded', initializeOAuthHandling);
        } else {
            // DOM already loaded, process immediately
            initializeOAuthHandling();
        }

        // Form initialization happens when showEmailMobileForm() is called

        // Handle Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const countryModal = document.getElementById('countryModal');

                if (countryModal && countryModal.classList.contains('show')) {
                    closeCountryModal();
                }
            }
        });
    </script>
</body>

</html>